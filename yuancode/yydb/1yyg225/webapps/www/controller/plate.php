<?php/** * ZZCMS 大转盘页面 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class plate extends Lowxp{    function __construct(){        parent::__construct();        $this->load->model('plate');    }    /* 大转盘封面     */    function index(){        $row['title'] = '幸运大转盘';        $data = array();        if(STPL == 'mobile'){            $row['head'] = $row['title'];            $this->smarty->assign('row',$row);        }        //获取最新的6个中奖者        $sql = "select * from ###_plate_log where star>0 order by id desc limit 6";        $list = $this->db->select($sql);        $list = $this->db->lJoin($list,'member','mid,nickname','mid','mid');        $this->smarty->assign('winList',$list);        //抵用券满减        $full_cut_discount = explode('|',$this->site_config['full_cut']);        if($full_cut_discount[0] || $full_cut_discount[1]){            $this->smarty->assign('full_cut_discount', $full_cut_discount);        }        //大转盘配置        $config_plate = $this->plate->configFormat();        $this->smarty->assign('config_plate', $config_plate);        //大转盘活动状态        $data = array_merge($data, $this->plate->plate_status());        $this->display_before($row);        $this->smarty->assign('data', $data);        $this->smarty->display('plate/index.html');    }    /* 大转盘异步生成抽奖码     */    function get(){        if(!isAjax()) die;        $this->load->model('member');        //token检查        if (!checkToken()) {            die(json_encode(array(                'status'      => -1,                'status_name' => '请刷新页面后抽奖！',                'status_btn'  => '刷新页面',                'status_url'  => '/plate',            )));        }        //大转盘配置        $config_plate = $this->plate->configFormat();        //大转盘活动状态        $plate_status = $this->plate->plate_status();        if($plate_status['status']<1){            die(json_encode($plate_status));        }        $mid = $_SESSION['mid'];        /* 生成抽奖码         * 未中奖0 一等奖1 二等奖2 三等奖3 四等奖4 五等奖5         */        $plate_points = array();        foreach($config_plate['plate_points'] as $k=>$v){            for($i=0;$i<$v;$i++){                $plate_points[] = $k;            }        }        $key = array_rand($plate_points,1);        $data['m'] = $plate_points[$key];        /***抽奖处理***/        //1消费人次 2扣除拍币        $cond = 1;        $cond_number = $config_plate['plate_db_points'];        if($plate_status['status']==3){            $cond = 2;            $cond_number = $config_plate['plate_pay_points'];        }        //赠送币数量        $plate_get_points = (int) $config_plate['plate_get_points'][$data['m']];        $plate_get_type = (int) $config_plate['plate_get_type'][$data['m']];        //中奖日志        $winConfig = $this->plate->winConfig;        $desc = '大转盘抽奖（'.$winConfig[$data['m']]['title'].'）';        //扣除拍币        if($cond == 2){            $log = array();            $log['mid'] = $mid;            $log['desc'] = $desc;            $log['pay_points'] = '-'.$cond_number;            $this->member->accountlog(ACT_PLATE,$log);        }        //中奖处理        if($data['m']>0 && $plate_get_points>0){            //返回获取商品描述            if($data['m']){                $star_type = $this->plate->getPoints($plate_get_type);                $data['desc'] = $plate_get_points . $star_type['title'];            }            //获得抵用券            if($plate_get_type==2){                $this->load->model('bonus');                $this->bonus->send(array(                    'mid'  => $mid,                    'desc' => $desc,                    'number' => $plate_get_points,                    'money' => 1,                ));            }else{                //赠送币                $log = array();                $log['mid'] = $mid;                $log['desc'] = $desc;                if($plate_get_type==1){                    $log['db_points'] = $plate_get_points;                }                if($plate_get_type==3){                    $log['pay_points'] = $plate_get_points;                }                $this->member->accountlog(ACT_PLATE,$log);            }        }        //写入抽奖日志        $insert = array(            'mid' => $mid,            'username' => $plate_status['username'],            'cond' => $cond,            'cond_number' => $cond_number,            'star' => $data['m'],            'star_type' => $plate_get_type ? $plate_get_type : 0,            'star_number' => $plate_get_points ? $plate_get_points : 0,            'desc' => $desc,            'c_time' => RUN_TIME,        );        $this->db->save('plate_log',$insert);        die(json_encode($data));    }}