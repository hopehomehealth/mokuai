<?php/** * ZZCMS 内容管理 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class content extends Lowxp{    function __construct(){        parent::__construct();        $this->load->model('content');        $this->load->model('category');        $this->load->model('form_field');    }    function index($m='',$page=1){        $this->chkModule($m);        if($m=='page'){            $this->tip('不允许直接查看单页模型内容',array('type'=>2));            $this->exeJs("history.back();");        }        #显示字段        $listshow = $this->base->explodeChar($this->moduleinfo['listshow'],',');        if(empty($listshow)) $listshow = array('title');        $this->smarty->assign('listshow',$listshow);        #获取状态配置        $data['status'] = $this->base->explodeChar($this->fieldsinfo['status']['setup']['options']);        if(array_keys($data['status'])==array(0,1) || array_keys($data['status'])==array(1,0)){            $data['isstatus'] = 1; //为1时，为正常状态结构，可以列表页直接更新        }        #检索表单        $listsearch = $this->base->explodeChar($this->moduleinfo['listsearch'],',');        if(empty($listsearch)) $listsearch = array('title','catid','posid','status');        $data['html_search'] = $this->content->searchForm($listsearch,$_GET);        #筛选        $conds = $this->content->getConds($listsearch);        $condition = count($conds) ? " WHERE ".implode(' AND ',$conds) : '';        $this->smarty->assign($_GET);        #分页        $this->load->model('page');        $_GET['page'] = intval($page);        $this->page->set_vars(array('per'=>(int)$this->common['page_listrows']));        #排序        $htorder = ' ORDER BY ';        if(trim($this->moduleinfo['htorder'])) $htorder .= $this->moduleinfo['htorder'];        else $htorder .= ' listorder DESC,id DESC';        #查询结果        $sql = "SELECT * FROM ###_".$m.$condition.$htorder;        $data['list'] = $this->page->hashQuery($sql,$m.'/')->result_array();        foreach($data['list'] as $k=>$v){            $v['thumb'] = json_decode($v['thumb'],true);            #格式化内容            foreach($listshow as $l){                if($this->fieldsinfo[$l]['type']=='textarea'){ $v[$l] = nl2br($v[$l]); }                if($this->fieldsinfo[$l]['type']=='images'){                    $array = json_decode($v[$l],true);                    $v[$l] = '<div class="table-images">';                    foreach($array as $i=>$r){                        $v[$l] .= '<a href="'.$r['path'].'" target="_blank"><img src="'.$r['path'].'" height="30" title="'.$r['title'].'" /></a>';                    }                    $v[$l] .= '</div>';                }                if($this->fieldsinfo[$l]['type']=='datetime'){                    $v[$l] = date('Y-m-d H:i:s',$v[$l]);                }                if(in_array($this->fieldsinfo[$l]['type'],array('select','radio','checkbox'))){                    $options = $this->base->explodeChar($this->fieldsinfo[$l]['setup']['options']);                    $array_val = explode(',',$v[$l]);                    $v[$l] = '';                    foreach($array_val as $i=>$r){                        if($i>0) $v[$l] .= ',';                        $v[$l] .= $options[$r];                    }                }                if($this->fieldsinfo[$l]['type']=='linkage'){                    $this->load->model('linkage');                    $v[$l] = $this->linkage->pos_linkage($v[$l],false);                }            }            $data['list'][$k] = $v;        }        $this->smarty->assign('fieldsinfo',$this->fieldsinfo);        $this->smarty->assign('data',$data);        $this->smarty->display('manage/content/list.html');    }    function edit($m){        $this->chkModule($m);        //提交        if(isset($_POST['Submit'])){            $res = $this->content->save();            if(isset($res['code']) && $res['code']==0){                $this->tip($res['message'],array('inIframe'=>true));                if($m=='page'){                    //$this->exeJs("parent.location.href='/manage#!category/index/'");                    $this->exeJs("parent.com.xhide();parent.main.refresh()");                }else{                    //$this->exeJs("parent.location.href='/manage#!content/index/".$m."'");                    $this->exeJs("parent.com.xhide();parent.main.refresh()");                }            }else{                $this->tip($res['message'],array('inIframe'=>true,'type'=>1));            }            exit;        }        $id = (int) $_GET['id'];        $row = array();        //编辑        if($id){            $row = $this->db->get("SELECT * FROM ###_".$m." WHERE id=".$id);            $this->smarty->assign('id',$id);            //修改单页模型内容时，判断是否存在，不存在则添加            if($m=='page'){                $row_category = $this->db->get("SELECT * FROM ###_category WHERE id=".$id." AND lang=".LANG_ID);                if(empty($row_category)){                    $this->tip('此单页模型栏目不存在',array('type'=>2));                    $this->exeJs("history.back();");                }                if(empty($row)){                    $this->db->insert($m,array(                        'id'=>$id,                        'title'=>$row_category['catname'],                        'hits'=>0,                        'lang'=>LANG_ID,                        'listorder'=>$row_category['listorder'],                        'status'=>1,                        'userid'=>UID,                        'username'=>USER,                        'createtime'=>time(),                        'updatetime'=>time(),                    ));                    $row = $this->db->get("SELECT * FROM ###_".$m." WHERE id=".$id);                }                #重置按钮                $this->btnMenu = array(                    0=>array('url'=>'#!category/index','name'=>'栏目管理'),                    1=>array('url'=>'#!category/edit?com=xshow|添加栏目','name'=>'添加栏目'),                );                $this->smarty->assign('btnMenu',$this->btnMenu);            }        }        //添加        else{            if($m=='page'){                $this->tip('不允许直接添加单页模型内容',array('type'=>2));                $this->exeJs("history.back();");            }        }        $row['module'] = $m;        $this->form_field->setData($row);        foreach($this->fieldsinfo as $k=>$v){            if(method_exists($this->form_field,$v['type'])){                $v['html'] = $this->form_field->$v['type']($v,'');            }            $this->fieldsinfo[$k] = $v;        }        $this->smarty->assign('fieldsinfo',$this->fieldsinfo);        if(!$id) $this->smarty->assign('btnNo',1);        $this->smarty->assign('row',$row);        $this->smarty->display('manage/content/edit.html');    }    //删除    function del($m){        $this->chkModule($m);        $id = (int) $_POST['id'];        if(!$id) die;        $title = $this->db->getstr("SELECT title FROM ".$m." WHERE id=".$id);        admin_log('删除'.$this->moduleinfo['title'].'：'.($title?$title:'ID='.$id));        $this->db->delete($m, array('id'=>$id));        $this->tip('删除成功',array('type'=>1));    }    #检查模型是否存在 and 获取模型和字段配置信息    function chkModule($m){        $this->content->chkModule($m);        $this->moduleinfo = $this->content->getModuleinfo();        $this->fieldsinfo = $this->content->getFieldsinfo();        $this->smarty->assign('moduleinfo',$this->moduleinfo);        $this->btnMenu = array(            0=>array('url'=>'#!content/index/'.$m,'name'=>$this->moduleinfo['title']),            1=>array('url'=>'#!content/edit/'.$m.'?com=xshow|添加内容','name'=>'添加内容'),        );        $this->smarty->assign('btnMenu',$this->btnMenu);    }}