<?php/** * ZZCMS 大转盘 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class plate extends Lowxp{    function __construct(){        #按钮        $this->btnMenu = array(            0=>array('url'=>'#!plate/config','name'=>'大转盘配置'),            1=>array('url'=>'#!plate/log','name'=>'抽奖记录'),        );        parent::__construct();        $this->load->model('plate');    }    //大转盘配置    function config(){        //获取大转盘中奖项        $this->smarty->assign('winConfig', $this->plate->winConfig);        //获取配置        $this->smarty->assign('config', $this->setting->value_other());        //赠送币种        $this->smarty->assign('points', $this->plate->getPoints());        $this->smarty->display('manage/plate/config.html');    }    //中奖记录    function log($page=1){        #检索        $conds = $this->getCondLog();        $condition = $conds['where'];        $orderby = $conds['order'];        #统计        if($_REQUEST['total']){            $data['pay_points'] = $this->db->getstr("SELECT SUM(cond_number) FROM ###_plate_log WHERE $condition AND `cond`=2");            $data['pai_number'] = $this->db->getstr("SELECT SUM(cond_number) FROM ###_plate_log WHERE $condition AND `cond`=1");        }        #分页        $this->load->model('page');        $_GET['page'] = intval($page);        $this->page->set_vars(array('per'=>(int)$this->common['page_listrows']));        #数据集        $sql = "SELECT * FROM ###_plate_log ".($condition!=''?" WHERE $condition":'') . $orderby;        $data['list'] = $this->page->hashQuery($sql)->result_array();        foreach($data['list'] as $k=>$v){            //抽奖条件            if($v['cond']==2){                $v['cond_info'] = '消耗'.$v['cond_number'].$this->L['unit_pay_points'];            }else{                $v['cond_info'] = '消费'.$v['cond_number'].'人次';            }            //中奖信息            $v['star_info'] = $this->plate->winConfig[$v['star']]['title'];            if($v['star']){                $star_type = $this->plate->getPoints($v['star_type']);                $v['star_info'] .= '（'.$v['star_number'].$star_type['title'].'）';            }            $data['list'][$k] = $v;        }        //获取大转盘中奖项        $this->smarty->assign('winConfig', $this->plate->winConfig);        $this->smarty->assign('data',$data);        $this->smarty->assign('btnNo',1);        $this->smarty->display('manage/plate/log.html');    }    function getCondLog(){        $where = ' 1 ';        $order = ' ORDER BY ';        #关键词搜索        $array = array('k','q');        foreach($array as $v){            if(!isset($_GET[$v]))$_GET[$v] = '';        }        $this->smarty->assign($_GET);        if(!empty($_GET['q'])){            $where .= " AND ".trim($_GET['k'])." LIKE '".addslashes($_GET['q'])."'";        }        //几等奖        if($_GET['star']){            if($_GET['star']==99){                $where .= " AND star=0";            }else{                $where .= " AND star=".$_GET['star'];            }        }        #快速排序        $order .= isset($_GET['sortby']) ? $_GET['sortby'] : 'id';        $order .= ' ';        $order .= isset($_GET['sortorder']) ? $_GET['sortorder'] : 'DESC';        return array('where'=>$where, 'order'=>$order);    }}