<?php/** * Name 众筹管理 * Class product_adm */class crowd_order extends Lowxp{    function __construct(){        #按钮        $this->btnMenu = array(            0=>array('url'=>'#!crowd/index','name'=>'订单管理')        );        parent::__construct();        $this->load->model('crowd');        $this->load->model('crowd_order');    }    /**     * IndexAction     */    function index($page=1){        $condtions = " WHERE support_id <> 0";        if(!empty($_GET['q'])){            if($_GET['k']=='cd_name') $condtions .= " AND c.cd_name LIKE '%".trim($_GET['q'])."%' ";            if($_GET['k']=='username') $condtions .= " AND c.username LIKE '%".trim($_GET['q'])."%' ";            if($_GET['k']=='member_username') $condtions .= " AND s.member_username LIKE '%".trim($_GET['q'])."%' ";            if($_GET['k']=='rt_name') $condtions .= " AND r.rt_name LIKE '%".trim($_GET['q'])."%' ";            if($_GET['k']=='support_sn') $condtions .= " AND s.support_sn LIKE '%".trim($_GET['q'])."%' ";        }        if($_GET['status']!=''){            $condtions .= " AND s.support_status = ".intval($_GET['status']);        }        if($_GET['is_success']!=''){            $condtions .= " AND s.crowd_is_success = ".intval($_GET['is_success']);        }        if($_GET['is_return']!=''){            $condtions .= " AND s.support_status = 6";        }        $condtions .= " ORDER BY support_created_time DESC";        $this->load->model('upload');        $this->smarty->assign($_GET);        #分页        $this->load->model('page');        $_GET['page'] = intval($page);        $this->page->set_vars(array('per'=>(int)$this->common['page_listrows']));        $sql = "SELECT s.*,r.rt_name,c.cd_id,c.cd_name,c.cd_total,c.username FROM ###_crowd_support AS s LEFT JOIN ###_crowd AS c ON s.crowd_id = c.cd_id        LEFT JOIN ###_crowd_return AS r ON s.return_id = r.rt_id ".$condtions;        $rows = $this->page->hashQuery($sql)->result_array();        $this->smarty->assign('list',$rows);        $this->smarty->display('manage/crowd_order/list.html');    }    /**     * 编辑订单     * @param $id     */    function edit($id=""){        $id = !empty($id) ? $id : $_POST['post']['id'];        $support = $this->db->get("SELECT c.*,s.* FROM ###_crowd_support AS s,###_crowd AS c WHERE s.crowd_id = c.cd_id AND s.support_id = '$id'");        $support['return_name'] = $this->db->getstr("SELECT rt_name FROM ###_crowd_return WHERE rt_id = '$support[return_id]'");        $support['nickname'] = $this->db->getstr("SELECT nickname FROM ###_member WHERE mid = '$support[mid]'");        $this->smarty->assign('support',$support);        $this->smarty->display('manage/crowd_order/edit.html');    }    /**     * 删除     * @param $id     */    function del(){        $id = (int) $_POST['id'];        if(!$id) die;        $order = $this->crowd_order->order_info($id);        if($order['status']==1) exit($this->tip('订单已支付无法删除',array('type'=>2)));        $this->crowd_order->del($id);        $this->tip('删除成功',array('type'=>1));    }    /**     * 导出     */    function export_order(){        $condtions = " WHERE order_id <> 0";        if(!empty($_GET['q'])){            if($_GET['k']=='cd_name') $condtions .= " AND c.cd_name LIKE '%".trim($_GET['q'])."%' ";            if($_GET['k']=='username') $condtions .= " AND o.username LIKE '%".trim($_GET['q'])."%' ";            if($_GET['k']=='support_user'){                $condtions .= " AND (s.username LIKE '%".trim($_GET['q'])."%' OR  s.nickname LIKE '%".trim($_GET['q'])."%')";            }            if($_GET['k']=='re_name') $condtions .= " AND r.re_name LIKE '%".trim($_GET['q'])."%' ";            if($_GET['k']=='order_id') $condtions .= " AND o.order_id LIKE '%".trim($_GET['q'])."%' ";            if($_GET['k']=='order_sn') $condtions .= " AND o.order_sn LIKE '%".trim($_GET['q'])."%' ";        }        if($_GET['status']!=''){            $condtions .= " AND o.status = ".intval($_GET['status']);        }        if($_GET['is_success']!=''){            $condtions .= " AND c.is_success = ".intval($_GET['is_success']);        }        if($_GET['is_return']!=''){            $condtions .= " AND o.is_return = ".intval($_GET['is_return']);        }        $condtions .= " ORDER BY add_time DESC";        $this->load->model('upload');        $sql = "SELECT o.*,c.cd_name,c.cd_total,r.re_name,s.username as support_name,s.nickname as support_nickname FROM ###_crowd_order AS o        LEFT JOIN  ###_crowd AS c ON c.cd_id=o.cd_id        LEFT JOIN ###_crowd_return AS r ON r.re_id = o.re_id        LEFT JOIN ###_member AS s ON o.support_mid = s.mid ".$condtions;        $list = $this->db->select($sql);        foreach($list as $k=>$v){            $list[$k]['add_time'] = date('Y-m-d H:i:s',$v['add_time']);            $list[$k]['is_return'] = $v['is_return']==1 ? '已回报' : '待回报';            if($v['is_success']==1){                $list[$k]['is_success'] = '已成功';            }elseif($v['is_success']==2){                $list[$k]['is_success'] = '已失败';            }else{                $list[$k]['is_success'] = '待结束';            }            if($v['status']==1){                $list[$k]['status'] = '已成功';            }elseif($v['status']==2){                $list[$k]['status'] = '已失败';            }else{                $list[$k]['status'] = '待结束';            }            $list[$k]['support_name'] = !empty($v['support_nickname']) ? $v['support_nickname'] : $v['support_name'];        }        $fields = array(            'order_sn'=>'订单号',            'cd_name'=>'众筹名称',            'return_name'=>'回报',            'mid'=>'会员ID',            'username'=>'会员名',            'order_amount'=>'支持金额',            'cd_total'=>'已筹金额',            'support_name'=>'支持艺人',            'status'=>'订单状态',            'is_success'=>'是否成功',            'is_return'=>'是否回报',            'add_time'=>'订单时间'        );        $this->load->model('share');        $this->share->SetExcelHeader('众筹订单-'.date('Y-m-d-H-i'),'');        $this->share->SetExcelBody($fields, $list);    }}