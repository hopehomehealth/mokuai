<?php/** * ZZCMS 抵用券 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class bonus extends Lowxp{    public $unit_bonus = '';    function __construct(){        parent::__construct();        $this->btnMenu = array(            0=>array('url'=>'#!bonus/index','name'=>$this->L['unit_bonus']),            1=>array('url'=>"#!bonus/edit?com=xshow|添加".$this->L['unit_bonus'],'name'=>"添加".$this->L['unit_bonus']),            2=>array('url'=>'#!bonus/user_bonus','name'=>"已发放的".$this->L['unit_bonus']),        );        #右侧按钮        $segments = Lowxp_Router::getInstance()->segments;        if(in_array($segments[2],array('user_bonus'))){            $this->btnRig = array(                0=>array('url'=>'javascript:;','name'=>'导出Excel','str'=>"onclick='exportExcel()' title='导出已筛选的内容'"),            );            $this->smarty->assign('btnRig',$this->btnRig);            $this->smarty->assign('btnNoRig',0);        }        //按钮菜单        $this->smarty->assign('btnMenu',isset($this->btnMenu)?$this->btnMenu:array());        $this->smarty->assign('btnNo',0);        $this->load->model('bonus');    }    #列表    function index($page=1){        #分页        $this->load->model('page');        $_GET['page'] = intval($page);        $this->page->set_vars(array('per'=>(int)$this->common['page_listrows']));        #数据集        $sql = "SELECT * FROM ".$this->bonus->baseTable." ORDER BY id DESC";        $data['list'] = $this->page->hashQuery($sql)->result_array();        foreach($data['list'] as $k=>$v){            $v['money_type_title'] = $this->bonus->getMoneyType($v['money_type']);            $v['send_type_title'] = $this->bonus->getSendType($v['send_type']);            $v['use_day_title'] = $this->bonus->getUseDay($v['use_day']);            $data['list'][$k] = $v;        }        /*$this->bonus->send(array(            'bonus_id' => 1,            'mid'      => 2,            'number'   => 5,        ));*/        $this->smarty->assign('data',$data);        $this->smarty->display('manage/bonus/list.html');    }    //创建/更新    function edit(){        //提交        if(isset($_POST['Submit'])){            $res = $this->bonus->save();            if(isset($res['code']) && $res['code']==0){                $this->tip($res['message'],array('inIframe'=>true));                $this->exeJs("parent.com.xhide();parent.main.refresh()");            }else{                $this->tip($res['message'],array('inIframe'=>true,'type'=>1));            }            exit;        }        $id = (int) $_GET['id'];        $row = array();        //编辑        if($id){            $row = $this->db->get("SELECT * FROM ".$this->bonus->baseTable." WHERE id=".$id);        }        if(!$id) $this->smarty->assign('btnNo',1);        $this->smarty->assign('row',$row);        $this->smarty->assign('money_types',$this->bonus->getMoneyType());        $send_types = $this->bonus->getSendType();        if(!$id){            unset($send_types[1]);            unset($send_types[2]);        }else{            if($row['send_type'] == 1){                unset($send_types[0]);                unset($send_types[2]);            }elseif($row['send_type'] == 2){                unset($send_types[0]);                unset($send_types[1]);            }else{                unset($send_types[1]);                unset($send_types[2]);            }        }        $this->smarty->assign('send_types',$send_types);        $this->smarty->assign('use_days',$this->bonus->getUseDay());        $this->smarty->display('manage/bonus/edit.html');    }    #发放券    function send(){        //提交        if(isset($_POST['Submit'])){            $post = $_POST['post'];            $users = explode("\n",$post['users']);            $send_type = isset($_POST['send_type']) ? trim($_POST['send_type']) : 'username';            $users = implode("','", $users);            if(empty($users)){                $this->tip('没有找到会员',array('inIframe'=>true,'type'=>1));die;            }            foreach($users as $k=>$v){                $users[$k] = trim($v);            }            $this->load->model('member');            $sql = "SELECT mid FROM ###_member WHERE $send_type IN('".$users."')";            $list = $this->db->select($sql);            if($list){                foreach($list as $v){                    $this->bonus->send(array(                        'bonus_id' => $_POST['id'],                        'mid'      => $v['mid'],                        'number'   => $post['number'],                        'desc'     => '管理员手动发放'.($post['desc']?('：'.$post['desc']):''),                    ));                }            }            admin_log("批量发放".$this->L['unit_bonus']."：".$post['id']);            $this->tip('发放成功',array('inIframe'=>true));            $this->exeJs("parent.com.xhide();parent.main.refresh()");            exit;        }        $id = (int) $_GET['id'];        $row = $this->db->get("SELECT * FROM ".$this->bonus->baseTable." WHERE id=".$id);        $this->smarty->assign('row',$row);        $this->smarty->display('manage/bonus/send.html');    }    #列表    function user_bonus($page=1){        $excel = (isset($_GET['excel'])&&$_GET['excel']==1)?1:0;        #检索        $conds = $this->getConds();        $condition = " WHERE 1 ";        $condition .= count($conds) ? " AND ".implode(' AND ',$conds) : '';        $orderby = " ORDER BY id DESC ";        #分页        $this->load->model('page');        $_GET['page'] = intval($page);        $this->page->set_vars(array('per'=>(int)$this->common['page_listrows']));        #数据集        $sql = "SELECT DISTINCT b.id,b.*,m.username FROM ".$this->bonus->mbTable ." AS b ".               "LEFT JOIN ###_member AS m ON m.mid=b.mid ".               $condition . $orderby;        if($excel==1){            $data['list'] = $this->db->select($sql);        }else{            $data['list'] = $this->page->hashQuery($sql)->result_array();        }        $data['list'] = $this->db->lJoin($data['list'],'bonus','id,title','bonus_id','id','b_');        $data['list'] = $this->db->lJoin($data['list'],'yunorder','order_id,order_sn','order_id','order_id','o_');        foreach($data['list'] as $k=>$v){            $v['money_type_title'] = $this->bonus->getMoneyType($v['money_type']);            if(!empty($v['order_id'])){                $v['disabled'] = 2; #使用            }elseif(!empty($v['end_time']) && $v['end_time']<time()){                $v['disabled'] = 1; #过期            }else{                $v['disabled'] = 0; #未使用            }            $data['list'][$k] = $v;        }        if($excel==1){            return $data['list'];        }        $this->smarty->assign('data',$data);        $this->smarty->assign('btnNo',2);        $this->smarty->display('manage/bonus/list_user_bonus.html');    }    /** 获取过滤条件     * @return array     */    function getConds(){        $where = array();        #关键词搜索        $array = array('k','q');        foreach($array as $v){            if(!isset($_GET[$v]))$_GET[$v] = '';        }        if(!empty($_GET['q'])){            $where[] = trim($_GET['k'])." LIKE '".addslashes($_GET['q'])."'";        }        if(isset($_GET['id']) && intval($_GET['id'])){            $where[] = "b.bonus_id=".intval($_GET['id']);            $row = $this->db->get("SELECT id,title FROM ".$this->bonus->baseTable." WHERE id=".intval($_GET['id']));            $this->btnMenu[2] = array('url'=>'#!bonus/user_bonus?id='.$row['id'],'name'=>'已发放的：'.$row['title']);        }        if(isset($_GET['status']) && intval($_GET['status'])){            $status = intval($_GET['status']);            if($status==1){ #未使用                $where[] = "b.order_id=0 AND (b.end_time<=0 OR b.end_time>".time().")";            }elseif($status==2){ #已使用                $where[] = "b.order_id>0";            }elseif($status==3){ #已过期                $where[] = "b.order_id=0 AND b.end_time>0 AND b.end_time<=".time();            }        }        $id1 = isset($_GET['id1']) ? $_GET['id1'] : 0;        $id2 = isset($_GET['id2']) ? $_GET['id2'] : 0;        if($id1){            $where[] = "b.id>='$id1'";        }        if($id2){            $where[] = "b.id<='$id2'";        }        $this->smarty->assign('btnMenu',$this->btnMenu);        $this->smarty->assign($_GET);        return $where;    }    //删除    function del(){        $id = (int) $_POST['id'];        if(!$id) die;        #必须保留一个        admin_log("删除".$this->L['unit_bonus']."：".$this->db->getstr("SELECT title FROM ".$this->bonus->baseTable." WHERE id=".$id));        $this->db->delete('###_bonus', array('id'=>$id));        $this->tip('删除成功',array('type'=>1));    }    //移除发放的抵用券    function del_user_bonus(){        $id = (int) $_POST['id'];        if(!$id) die;        admin_log("删除发放的".$this->L['unit_bonus']."：".$id);        $this->db->delete('###_member_bonus', array('id'=>$id));        $this->tip('删除成功',array('type'=>1));    }    /**     * 导出Excel     */    function exportExcel(){        set_time_limit(0);        $this->load->model('share');        $_GET['excel'] = 1;        $list = array();        //导出会员信息        $data = $this->user_bonus();        foreach($data as $k=>$v){            $v['b_title'] = $v['b_title'] . '（'.$v['money'].$v['money_type_title'].'）';            $v['start_time'] = $v['start_time'] ? date('Y-m-d H:i:s', $v['start_time']) : '---';            $v['end_time'] = $v['end_time'] ? date('Y-m-d H:i:s', $v['end_time']) : '---';            $v['user_info'] = $v['username'] . '（'.$v['mid'].'）';            $v['used_time'] = $v['used_time'] ? date('Y-m-d H:i:s', $v['used_time']) : '---';            $v['o_order_sn'] = $v['o_order_sn'].'‘';            $v['status_name'] = '未使用';            if($v['disabled'] == 2){ $v['status_name'] = '已使用'; }            if($v['disabled'] == 1){ $v['status_name'] = '已过期'; }            $list[] = $v;        }        $fields = array(            'id'=>'id',            'bonus_sn'=>'红包序列号',            'b_title'=>'红包名称/价值',            'start_time'=>'有效时间（开始）',            'end_time'=>'有效时间（截止）',            'user_info'=>'所属会员（ID）',            'desc'=>'获取途径',            'used_time'=>'使用时间',            'o_order_sn'=>'云购订单号',            'status_name'=>'状态',        );        $this->share->SetExcelHeader('已发放抵用券-'.date('Y-m-d H:i:s'),'已发放抵用券');        $this->share->SetExcelBody($fields, $list);    }}