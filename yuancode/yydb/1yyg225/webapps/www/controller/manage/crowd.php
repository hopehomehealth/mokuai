<?php/** * Name 众筹管理 * Class product_adm */class crowd extends Lowxp{    function __construct(){        parent::__construct();        #按钮        $this->btnMenu = array(            0=>array('url'=>'#!crowd/index','name'=>'众筹管理'),        );        //按钮菜单        $this->smarty->assign('btnMenu',isset($this->btnMenu)?$this->btnMenu:array());        $this->smarty->assign('btnNo',0);        $this->load->model('crowd');        $this->load->model('crowd_cat');    }    /**     * IndexAction     */    function index($page=1){        $condtions = " WHERE cd_id <> 0";        if(!empty($_GET['q'])){            $condtions .= " AND ".trim($_GET['k'])." LIKE %".trim($_GET['q'])."%";        }        if($_GET['status']!=''){            $condtions .= " AND status = '".intval($_GET['status'])."'";        }else{            $condtions .= " AND status != 0";        }        if($_GET['success']!=''){            $condtions .= " AND is_success = '".intval($_GET['success'])."'";        }        $condtions .= " ORDER BY listorder DESC,cd_id DESC";        $this->load->model('upload');        #分页        $this->load->model('page');        $_GET['page'] = intval($page);        $this->page->set_vars(array('per'=>(int)$this->common['page_listrows']));        $sql = "SELECT * FROM ###_crowd ".$condtions;        $rows = $this->page->hashQuery($sql)->result_array();        $status_str = array();        $status_str[0] = '未提交';        $status_str[1] = '待审核';        $status_str[2] = '已通过';        $status_str[3] = '已拒绝';        $success_str[0] = '待结束';        $success_str[1] = '筹资成功';        $success_str[2] = '筹资失败';        if(!empty($rows)){            foreach($rows as $key=>$val){                $rows[$key]['status_str'] = $status_str[$val['status']];                $rows[$key]['success_str'] = $success_str[$val['is_success']];            }        }        $this->smarty->assign('list',$rows);        $cats = $this->crowd_cat->select();        $this->smarty->assign('cats',$cats);        $this->smarty->display('manage/crowd/list.html');    }    function edit($id=""){        $id = !empty($id) ? $id : 0;        //提交        if(isset($_POST['Submit'])){            $this->load->model('linkage');            $post = $_POST['post'];            $post['cd_name'] = !empty($post['cd_name']) ? trim($post['cd_name']) : '';            $post['cd_desc'] = !empty($post['desc']) ? trim($post['desc']) : '';            $post['reason'] = !empty($post['reason']) ? trim($post['reason']) : '';            if(empty($post['cd_name'])){ $this->tip('请输入众筹名称',array('inIframe'=>true,'type'=>1)); exit;}            if(empty($post['area_id'])){ $this->tip('请选择项目地点',array('inIframe'=>true,'type'=>1)); exit;}            $post['area_id'] = end($post['area_id']);            $post['thumb'] = end($post['thumb']['path']);            $post['area_id_info'] = $this->linkage->pos_linkage($post['area_id'],false,' ');            if($post['status']==3 && empty($post['reason'])){ $this->tip('请输入拒绝原因',array('inIframe'=>true,'type'=>1));exit;}            if($post['status']==2){                $post['end_time'] = strtotime('+'.floor($post['day']).' day');                //加入无私奉献回报                $return = array('rt_name'=>'无私奉献','cd_id'=>$post['id']);                $this->db->insert('crowd_return',$return);            }            $post['content'] = stripslashes($post['content']);            $result = $this->db->save('crowd',$post,'',"cd_id = '$post[id]'");            $this->db->save('crowd_detail',$post,'',"cd_id = '$post[id]'");            if($result){                $this->tip('操作成功',array('inIframe'=>true,'type'=>1));                $this->exeJs('parent.location.href="/manage#!crowd/index";');            }else{                $this->tip('操作失败',array('inIframe'=>true,'type'=>1));            }        }        if(!empty($id)){            $row = $this->crowd->get_info($id);        }        $cats = $this->crowd_cat->select();        $this->smarty->assign('cats',$cats);        $this->load->model('linkage');        $area = $this->linkage->select_linkage($row['area_id'] ? $row['area_id'] : 1,3,'area_id');        $this->smarty->assign('area',$area);        $row['html_thumb'] = $this->form->files('thumb',json_encode(array(0=>array('path'=>$row['thumb']))));        $row['html_content'] = $this->form->editor('content',$row['content'],'name="post[content]" style="width:100%;height:200px;"',array('toolbar'=>'basic'));        $row['return'] = $this->crowd->get_return("cd_id = '$id'");        $this->smarty->assign('row',$row);        $this->smarty->display('manage/crowd/edit.html');    }    /**     * 删除     * @param $id     */    function del(){        $id = (int) $_POST['id'];        if(!$id) die;        if($id){            //是否已有支持者            $support_count = $this->db->getstr("SELECT * FROM ###_crowd_order WHERE cd_id = ".$id." AND status = 1");            if($support_count) exit($this->tip('该众筹已有支持者无法删除',array('type'=>2)));        }        $this->crowd->del($id);        $this->tip('删除成功',array('type'=>1));    }    /**     * 统计     */    function statis(){        $where = "support_id <> 0";        if(!empty($_GET['start_time'])) $where .= " AND pay_time >= ".strtotime($_GET['start_time']);        if(!empty($_GET['end_time'])) $where .= " AND pay_time <= ".strtotime($_GET['start_time']);        $statis = array();        $statis['object_total'] = $this->db->getstr("SELECT SUM(support_amount) FROM ###_crowd_support WHERE $where");        $statis['success_total'] = $this->db->getstr("SELECT SUM(support_amount) FROM ###_crowd_support WHERE $where AND (support_status >= 4 OR support_status = 2)");        $statis['fail_total'] = $this->db->getstr("SELECT SUM(support_amount) FROM ###_crowd_support WHERE $where AND support_status IN (0,1,3)");        $statis['object_num'] = $this->db->getstr("SELECT COUNT(cd_total) FROM ###_crowd WHERE cd_id <> 0 AND status > 0");        $statis['success_num'] = $this->db->getstr("SELECT COUNT(cd_total) FROM ###_crowd WHERE cd_id <> 0 AND is_success = 1");        $statis['fail_num'] = $this->db->getstr("SELECT COUNT(cd_total) FROM ###_crowd WHERE cd_id <> 0 AND is_success = 2");        $statis['ing_num'] = $this->db->getstr("SELECT COUNT(cd_total) FROM ###_crowd WHERE cd_id <> 0 AND is_success = 0 AND status = 2");        $statis['check_num'] = $this->db->getstr("SELECT COUNT(cd_total) FROM ###_crowd WHERE cd_id <> 0 AND status = 1");        $this->smarty->assign('row',$statis);        $this->smarty->display('manage/crowd/statis.html');    }}