<?php/** * ZZCMS 充值卡 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class recharge_card extends Lowxp{    function __construct(){        parent::__construct();        $this->load->model('recharge_card');        $this->lang_card = $lang = $this->recharge_card->lang();        $this->btnMenu = array(            0=>array('url'=>'#!recharge_card/index','name'=>$lang['card']."管理"),            1=>array('url'=>"#!recharge_card/edit?com=xshow|"."批量发放".$lang['card'],'name'=>"批量发放".$lang['card']),            2=>array('url'=>"#!recharge_card/config",'name'=>$lang['card']."配置"),        );        //按钮菜单        $this->smarty->assign('btnMenu',isset($this->btnMenu)?$this->btnMenu:array());        $this->smarty->assign('btnNo',0);    }    #列表    function index($page=1){        $excel = (isset($_GET['excel'])&&$_GET['excel']==1)?1:0;        #检索        $where = ' WHERE 1';        if(!empty($_GET['q'])){            if($_GET['q'] == 'username'){                $where .= " AND ".trim($_GET['k'])." LIKE '".addslashes($_GET['q'])."'";            }else{                $where .= " AND ".trim($_GET['k'])." LIKE '%".addslashes($_GET['q'])."%'";            }        }        if(isset($_GET['vr_status_1']) && $_GET['vr_status_1']>0){            if($_GET['vr_status_1'] == 1){ //未消费                $where .= " AND vr_status=0";            }else{ //已消费                $where .= " AND vr_status=1";            }        }        if(isset($_GET['vr_status_2']) && $_GET['vr_status_2']>0){            if($_GET['vr_status_2'] == 1){ //未过期                $where .= " AND vr_time_end=0 || vr_time_end>=".time();            }else{ //已过期                $where .= " AND vr_time_end>0 && vr_time_end<".time();            }        }        if(isset($_GET['vr_status_3']) && $_GET['vr_status_3']>0){            if($_GET['vr_status_3'] == 1){ //非线下发放                $where .= " AND vr_online=0";            }else{ //线下发放                $where .= " AND vr_online=1";            }        }        $this->smarty->assign($_GET);        #分页        $this->load->model('page');        $_GET['page'] = intval($page);        $this->page->set_vars(array('per'=>(int)$this->common['page_listrows']));        #数据集        $sql = "SELECT * FROM ".$this->recharge_card->baseTable.$where." ORDER BY id DESC";        if($excel==1){            $data['list'] = $this->db->select($sql);        }else{            $data['list'] = $this->page->hashQuery($sql)->result_array();        }        foreach($data['list'] as $k=>$v){            $v['vr_type_name'] = $this->recharge_card->vr_type($v['vr_type']);            $v['vr_pass_code'] = $this->base->decrypt($v['vr_pass']);            //获取卡状态描述            $v['vr_status_desc'] = '';            if($v['vr_status'] == 1){                $v['vr_status_desc'] .= '<span class="c-gray">已使用 '.($v['vr_time_use'] ? '（<a href="/minfo?id='.$v['mid'].'" target="_blank">'.$v['username'].'</a> 于 '.date('Y-m-d H:i',$v['vr_time_use']).'）' : '');            }elseif($v['vr_time_end'] > 0 && $v['vr_time_end'] < time()){                $v['vr_status_desc'] .= '<span class="c-gray">已过期</span>';            }elseif($v['vr_status'] == 0){                $v['vr_status_desc'] .= '未使用';            }            if($v['vr_online'] == 1){                $v['vr_status_desc'] .= '<span class="c-orange">（线下发放）</span>';            }            $data['list'][$k] = $v;        }        if($excel==1){            return $data['list'];        }        $this->smarty->assign('lang_card',$this->lang_card);        $this->smarty->assign('data',$data);        $this->smarty->display('manage/recharge_card/list.html');    }    //创建/更新    function edit(){        //提交        if(isset($_POST['Submit'])){            $res = $this->recharge_card->save();            if(isset($res['code']) && $res['code']==0){                $this->tip($res['message'],array('inIframe'=>true));                $this->exeJs("parent.com.xhide();parent.main.refresh()");            }else{                $this->tip($res['message'],array('inIframe'=>true,'type'=>1));            }            exit;        }        $id = (int) $_GET['id'];        $row = array();        //编辑        if($id){            $row = $this->db->get("SELECT * FROM ".$this->recharge_card->baseTable." WHERE id=".$id);        }        //充值卡类型        $this->smarty->assign('vr_type', $this->recharge_card->vr_type());        //有效期限        $this->smarty->assign('vr_time_end', $this->recharge_card->vr_time_end());        if(!$id) $this->smarty->assign('btnNo',1);        $this->smarty->assign('row',$row);        $this->smarty->assign('lang_card',$this->recharge_card->lang_card);        $this->smarty->display('manage/recharge_card/edit.html');    }    //删除    function del(){        $id = (int) $_POST['id'];        if(!$id) die;        #必须保留一个        admin_log("删除".$this->lang_card['card']."：".$this->db->getstr("SELECT vr_number FROM ".$this->recharge_card->baseTable." WHERE id=".$id));        $this->db->delete('###_recharge_card', array('id'=>$id));        $this->tip('删除成功',array('type'=>1));    }    /**     * 导出Excel     */    function exportExcel(){        $this->load->model('share');        $_GET['excel'] = 1;        $data = $this->index();        $list = array();        foreach($data as $k=>$v){            $v['vr_number'] = 'SN:'.$v['vr_number'];            $v['vr_money'] = $v['vr_money'] . ' ' . $v['vr_type_name'];            $v['vr_time_end'] = $v['vr_time_end'] ? date('Y-m-d H:i',$v['vr_time_end']) : '永久有效';            $v['vr_status_desc'] = strip_tags($v['vr_status_desc']);            $list[] = $v;        }        $fields = array(            'vr_number'=>'卡号',            'vr_pass_code'=>'卡密',            'vr_money'=>'面值',            'vr_time_end'=>'有效期',            'vr_status_desc'=>'卡状态',        );        $this->share->SetExcelHeader('充值卡-'.date('Y-m-d H:i:s'),'充值卡');        $this->share->SetExcelBody($fields, $list);    }    //充值卡配置    function config(){        //获取配置        $this->smarty->assign('config', $this->setting->value_other());        $this->smarty->assign('lang_card',$this->lang_card);        $this->smarty->assign('btnNo', 2);        $this->smarty->display('manage/recharge_card/config.html');    }}