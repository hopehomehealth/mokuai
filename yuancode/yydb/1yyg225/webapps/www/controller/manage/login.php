<?php/** * ZZCMS 管理员登录 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class login extends Lowxp{    function __construct(){        parent::__construct();        $this->load->model('user');        if(isset($_SESSION['uid']) && isset($_SERVER['request']['method'])){            $method = $_SERVER['request']['method'];            if($method != 'destroy'){                //todo:让用户选择退出登录或跳转到home                $this->exeJs('alert("当前已登录,该操作需在未登录状态下.");');                //跳转到一个初始页面                $this->exeJs('location.href="/manage/login/destroy"');                #$this->exeJs('location.href="/welcome";');                die;            }        }    }    /**     * 首页     */    function index(){        $this->smarty->display('manage/login/login.html');    }    /**     * 显示错误     * @param $msg     */    private function showError($msg){        $this->exeJs('alert("'.$msg.'");');die;    }    /**     * 登录     */    function submit(){    	$_POST    && SafeFilter($_POST);        $username = $_POST['username'];        $password = $_POST['password'];        if(isset($this->common['verify_admin']) && $this->common['verify_admin']){            $scode = trim($_POST['scode']);            if($scode != -1 && strtolower($scode) != strtolower($_SESSION['icode']))$this->showError('验证码错误!');        }        $user = $this->db->get("SELECT * FROM ###_m_user WHERE username='".$username."'");        $mobile = $user['tel'];        //短信验证码        $verifycode = '';        if($this->common['managesms']==1 && $mobile){            $this->load->library('sms');            $verifycode = empty($_POST['sms_code']) ? '' : trim($_POST['sms_code']);            /* 验证手机号验证码和IP */            $sql = "SELECT COUNT(id) FROM ###_verify_code WHERE mobile='$mobile' AND getip='" . getIP() . "' AND verifycode='$verifycode' AND (status=1 OR status=10) AND dateline>'" . time() ."'-3600";//验证码60分钟内有效            if ($this->db->getstr($sql) == 0) {                $this->showError('手机号和验证码不匹配 或者 验证码已过期（1小时内有效）！');            }        }        $result = safe_verify($user,$username,$password);        if($result){            $this->db->update('verify_code', array(                'status' => 2,            ), "`mobile`='$mobile' AND `verifycode`='$verifycode' AND `getip`='" . getIP() . "' AND `status`='1' AND `dateline`>" . (time()-3600));            $this->exeJs("top.location.href='/manage/init'");        }else{            $this->showError('账号或密码错误!');        }    }    /**     * 退出登录     */    function destroy(){        $_SESSION = array();        #unset($_SESSION['username']);unset($_SESSION['uid']);unset($_SESSION['gid']);        header('Location:/manage/login');    }}