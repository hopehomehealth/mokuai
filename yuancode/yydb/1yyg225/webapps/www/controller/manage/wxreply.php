<?php/** * Name 微信自动回复 * Class wxreply */class wxreply extends Lowxp{    /**     * 微信菜单设置     */    function index(){        $this->subscribe();    }    function getRule($ruleType = 'subscribe'){        $company_id = 0;        $sql = "SELECT * FROM wx_autoreply_rule WHERE rule_type='".$ruleType."' AND company=".$company_id;        $rule = $this->db->get($sql);        if(!isset($rule['id'])){            $this->db->insert('wx_autoreply_rule',array(                'company'=>$company_id,'name'=>'subscribe',                'rule_type'=>$ruleType,'c_time'=>RUN_TIME            ));            $rule = $this->db->get($sql);        }        return $rule;    }    /**     * 关注     */    function subscribe(){        $this->getReplyMsg();    }    /**     * 缺省匹配     */    function autoreply(){        $this->getReplyMsg('autoreply');    }    function getReplyMsg($type = 'subscribe'){        $rule = $this->getRule($type);        $rule['reply_list'] = json_decode($rule['reply_list'],true);        $msgType = empty($rule['reply_list']['msg_type']) ? 'text' : $rule['reply_list']['msg_type'];        $data = empty($rule['reply_list']['msg_id']) ? '' : $rule['reply_list']['msg_id'];        if($msgType=='text' && is_numeric($data)){            $text = $this->db->get("SELECT * FROM wx_autoreply_text WHERE id=".$data);            $data = str_replace("\n", '', $text['content']);        }        $this->smarty->assign('type',$type);        $this->smarty->assign('msg_type',$msgType);        $this->smarty->assign('data',$data);        $this->smarty->display('manage/wxreply/index.html');    }    /**     * 提交关注回复与消息回复     */    function submitform(){        #echo '<pre>';print_r($_POST);echo '</pre>';die;        $_POST['data'] = strip_tags($_POST['data']);        $company_id = 0;        in_array($_POST['reply_type'],array('subscribe','autoreply')) || $this->fatalError('类型错误!');        $rType = $_POST['reply_type'];        $sql = "SELECT * FROM wx_autoreply_rule WHERE rule_type='".$rType."' AND company=".$company_id;        $rule = $this->db->get($sql);        $rule_id = $rule['id'];        $this->db->delete('wx_autoreply_text',array('rule_id'=>$rule_id));        //回复内容更新        $msg_count = array('news'=>0,'text'=>0,'wheel'=>0,'image'=>0);        $reply_list = array();        $msgType = $_POST['type'];        $msg_id = '';        switch($msgType){            case 'news':                $msg_id = $_POST['data'];                $msg_count['news']++;                break;            case 'text':                $this->db->insert('wx_autoreply_text',array(                    'rule_id'=>$rule_id,                    'content'=>$_POST['data']                ));                $msg_id = $this->db->insert_id();                $msg_count['text']++;                break;            case 'wheel':                $msg_id = $_POST['data'];                $msg_count['wheel']++;                break;        }        if($msg_id!='')$reply_list = array(            'msg_type'=>$msgType,            'msg_id'=>$msg_id        );        $this->db->update('wx_autoreply_rule',array(            'msg_count'=>json_encode($msg_count),            'reply_list'=>json_encode($reply_list)        ),array('id'=>$rule_id));        $this->tip('更新成功!');    }    /**     * 聊天机器人     */    function chat(){        $setting = array('tlkey'=>'图灵KEY','tlapi'=>'图灵API');        foreach($setting as $type=>$title){            $row = $this->db->get("SELECT * FROM site_info WHERE type='$type'");            if(!isset($row['id'])){                $this->db->insert('site_info',array('title'=>$title,'type'=>$type));                $row = $this->db->get("SELECT * FROM site_info WHERE type='$type'");            }            $this->smarty->assign($type,$row);        }        $this->smarty->display('manage/wxreply/chat.html');    }    /**     * 更新聊天机器人     */    function submitchat(){        if(is_array($_POST)){            foreach($_POST as $key=>$val){                $input = array('content'=>trim($val));                $this->db->update('site_info',$input,array('type'=>$key));            }        }        $this->tip('更新成功!',array('inIframe'=>'true'));    }    /**     * 获取图文回复     */    function getNewsList(){        $wxnews = $this->db->select("SELECT * FROM wx_news");        $this->load->model('wxnews');        $wxnews = $this->wxnews->setNewsInfo($wxnews);        $this->smarty->assign('list',$wxnews);        $this->smarty->display('manage/wxreply/news_list.html');    }    /**     * 获取选中的图文     */    function selectNews($id){        $wxnews = $this->db->select("SELECT * FROM wx_news WHERE id = '$id'");        $this->load->model('wxnews');        $wxnews = $this->wxnews->setNewsInfo($wxnews);        $html = '<table class="list" id="news" style="width: 100%">';        foreach($wxnews[0]['items'] as $m){            $html .= "<tr><td class='bdl w5'></td><td class='w50'><img src='$m[imgurl_thumb]' width='50'/></td><td><div class='oi-name'>$m[title]</div></td></tr>";        }        $html .='</table>';        echo $html;    }    function editkey($id=''){        $data = $this->db->get("SELECT * FROM wx_reply WHERE re_id='$id'");        $data['keyword'] = unserialize($data['keyword']);        if($data['data_type']==3){            $wxnews = $this->db->select("SELECT * FROM wx_news WHERE id = '$data[content]'");            $this->load->model('wxnews');            $wxnews = $this->wxnews->setNewsInfo($wxnews);            $this->smarty->assign('wxnews',$wxnews[0]['items']);        }        $this->smarty->assign('data',$data);        $this->smarty->display('manage/wxreply/editkey.html');    }    function addkey(){        $this->smarty->display('manage/wxreply/editkey.html');    }    /**     * 提交关键字回复     */    function submitkey(){        $id = intval($_POST['id']);        $input = array();        $input['re_type'] = 3;        $input['rule_name'] = trim($_POST['rule_name']);        $input['data_type'] = $_POST['data_type'] ?  intval($_POST['data_type']) : 1;        if($_POST['data_type']==3){            $input['content'] = intval($_POST['newsid']);        }else{            $input['content'] = trim($_POST['content']);        }        $kw = array();        if($_POST['kw']){            foreach($_POST['kw'] as $key=>$val){                if($val){                    $kw[$key]['key'] = trim($val);                    $kw[$key]['match'] = $_POST['match'][$key]==1 ? 1 : 0;                }            }        }        $input['keyword'] = serialize($kw);        if(empty($id)){            $this->db->insert('wx_reply',$input);        }else{            $this->db->update('wx_reply',$input,array('re_id'=>$id));        }        $this->tip('提交成功!');        $this->exeJs('location.href="/manage#!wxreply/setkey";');    }    /**     * 删除关键字匹配     */    function del($id){        $this->db->delete('wx_reply',array('re_id'=>$id));        $this->tip('删除成功!');        $this->exeJs('main.refresh();');    }}