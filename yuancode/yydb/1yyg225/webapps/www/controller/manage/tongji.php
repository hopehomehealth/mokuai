<?php/** * 225 商城数据统计 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class tongji extends Lowxp{    function __construct(){        #按钮        $this->btnMenu = array(            0=>array('url'=>'#!tongji/money','name'=>'资金统计'),        );        parent::__construct();    }    #资金统计    function money(){        #支付方式        $this->load->model('payment');        $payment = $this->payment->getPayment("is_cod<>1 AND pay_code<>'balance'");        #检索        $where_member_account = $where_order = '';        $start_time = isset($_GET['start_time'])?trim($_GET['start_time']):'';        $start_time = $start_time ? strtotime($start_time." 00:00:00") : '';        if($start_time){            $where_member_account .= " AND add_time>".$start_time;            $where_order = " AND go.c_time>".$start_time;        }        $end_time = isset($_GET['end_time'])?trim($_GET['end_time']):'';        $end_time = $end_time ? strtotime($end_time." 23:59:59") : '';        if($end_time){            $where_member_account .= " AND add_time<=".$end_time;            $where_order = " AND go.c_time<=".$end_time;        }        $mid = isset($_GET['mid']) ? trim($_GET['mid']) : 0;        if($mid){            $where_member_account .= " AND mid=".$mid;            $where_order .= " AND go.mid=".$mid;        }        if(!isset($_GET['pay_ids'])){            foreach($payment as $v){                if($v['enabled']==1){                    $_GET['pay_ids'][$v['pay_id']] = $v['pay_id'];                }            }        }        $pay_ids = isset($_GET['pay_ids']) ? $_GET['pay_ids'] : '';        if($pay_ids){            $where_member_account .= " AND (pay_id=-9999";            foreach($pay_ids as $pay_id){                $where_member_account .= " OR pay_id=".$pay_id;            }            $where_member_account .= " )";        }        #第三方充值        $sql = "SELECT SUM(amount) as total FROM `###_member_account` WHERE mid<>0 AND type='1' AND status='2' ".$where_member_account;        $data['in'] = $this->db->getstr($sql);        #第三方支付        $sql = "SELECT SUM(order_amount) as total FROM `###_yunorder` WHERE mid<>0 AND order_amount>0 AND pay_id>0 AND status>1 ".$where_member_account;        $data['in_pay'] = $this->db->getstr($sql);        #提现        $sql = "SELECT SUM(amount) as total FROM `###_member_account` WHERE mid<>0 AND type='2' AND status='2' ".$where_member_account;        $data['out'] = $this->db->getstr($sql);        #成本        $cost = isset($_GET['cost']) ? intval($_GET['cost']) : 1;        if($cost == 2){            $sql = "SELECT SUM(`oldprice`) FROM ###_goods_order AS go WHERE go.status>1 AND go.status<5 $where_order";            $data['cost'] = $this->db->getstr($sql);        }else{            $sql = "SELECT SUM(`price`) FROM ###_goods WHERE id IN(                SELECT goi.good_id FROM `###_goods_order_item` AS goi                LEFT JOIN `###_goods_order` AS go ON go.id=goi.order_id                WHERE go.status>1 AND go.status<5 $where_order                )";            $data['cost'] = $this->db->getstr($sql);        }        #收入统计        $data['total'] = $data['in']+$data['in_pay']-$data['out']-$data['cost'];        $this->smarty->assign($_GET);        $this->smarty->assign('data',$data);        $this->smarty->assign('payment',$payment);        $this->smarty->display('manage/tongji/money.html');    }}