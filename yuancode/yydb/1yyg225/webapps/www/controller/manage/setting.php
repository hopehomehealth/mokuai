<?php/** * ZZCMS 站点配置 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class setting extends Lowxp{    function __construct(){    	#按钮    	$this->btnMenu = array(    	'index'=>array('url'=>'#!setting/index','name'=>'站点配置'),    	'system'=>array('url'=>'#!setting/index/system','name'=>'系统参数'),    	'money'=>array('url'=>'#!setting/index/money','name'=>'积分相关'),    	'mail'=>array('url'=>'#!setting/index/mail','name'=>'邮箱配置'),    	'sms'=>array('url'=>'#!setting/index/sms','name'=>'短信接口'),    	'oauth'=>array('url'=>'#!setting/index/oauth','name'=>'第三方登录'),    	'iface'=>array('url'=>'#!setting/index/iface','name'=>'其它接口'),    	//'page'=>array('url'=>'#!setting/index/page','name'=>'分页配置'),    	//'attach'=>array('url'=>'#!setting/index/attach','name'=>'附件配置'),    	'images'=>array('url'=>'#!setting/index/images','name'=>'图片碎片'),    	'words'=>array('url'=>'#!setting/index/words','name'=>'文字碎片'),    	'skin'=>array('url'=>'#!setting/index/skin','name'=>'模板风格'),    	'crowd'=>array('url'=>'#!setting/index/crowd','name'=>'众筹相关'),    	'add'=>array('url'=>'#!setting/index/add','name'=>'添加系统变量'),    	);    	     	parent::__construct();    	$this->images_data = array(    		'duobao_button' => array('title'=>'首页夺宝按钮','guige'=>'136*45','url'=>'','des'=>'','name'=>'btn-db.gif','address'=>'style/images/sd/'),    		'liaojie' => array('title'=>'首页了解图片','guige'=>'230*162','url'=>'','des'=>'','name'=>'index1_1.jpg','address'=>'style/images/'),    		'qidai' => array('title'=>'敬请期待','guige'=>'240*364','url'=>'yunbuy','des'=>'','name'=>'alt_blank_s.jpg','address'=>'style/images/'),    		'newmember' => array('title'=>'新会员夺宝','guige'=>'74*81','url'=>'content/tiyan/db','des'=>'','name'=>'member_db.png','address'=>'style/images/'),    		'tehuiduobao' => array('title'=>'特惠夺宝','guige'=>'74*78','url'=>'content/tiyan/db','des'=>'','name'=>'sale_db.png','address'=>'style/images/'),    		'shaidan' => array('title'=>'晒单领夺宝币','guige'=>'170*36','url'=>'content/share','des'=>'','name'=>'shareB.png','address'=>'style/images/'),    		'jiangli1' => array('title'=>'奖励1夺宝币','guige'=>'77*93','url'=>'','des'=>'在个人空间，晒单中','name'=>'db_win.png','address'=>'style/images/'),    		'jiangli5' => array('title'=>'奖励5夺宝币','guige'=>'77*93','url'=>'','des'=>'在个人空间，晒单中','name'=>'db_win5.png','address'=>'style/images/'),    		'yunbuy' => array('title'=>'一元云购','guige'=>'75*75','url'=>'content/win#db','des'=>'','name'=>'default.gif','address'=>'upload/'),    		'man' => array('title'=>'默认头像（男）','guige'=>'250*250','url'=>'member','des'=>'','name'=>'man.png','address'=>'upload/'),    		'woman' => array('title'=>'默认头像（女）','guige'=>'250*250','url'=>'member','des'=>'','name'=>'woman.png','address'=>'upload/'),    		'dakai' => array('title'=>'打开'.$this->common['site_name'],'guige'=>'642*95','url'=>'/content/chart','des'=>'','name'=>'head_1.gif','address'=>'style/images/chart/'),    		'daohang' => array('title'=>'导航分类','guige'=>'642*95','url'=>'content/chart','des'=>'','name'=>'head_2.gif','address'=>'style/images/chart/'),    		'jiexiao' => array('title'=>'揭晓','guige'=>'255*405','url'=>'','des'=>'在未开过奖的产品详情右侧','name'=>'xye.png','address'=>'style/images/'),    		'denglu' => array('title'=>'登录','guige'=>'1158*525','url'=>'member/login','des'=>'','name'=>'login-bg.gif','address'=>'style/images/login/'),    		'zhuce' => array('title'=>'注册','guige'=>'527*333','url'=>'member/regist','des'=>'','name'=>'regist-bg.gif','address'=>'style/images/login/'),    		'sjtx' => array('title'=>'手机站头像','guige'=>'75*75','url'=>'member','des'=>'','name'=>'photo_mid.jpeg','address'=>'upload/'),            'ico' => array('title'=>'浏览器头部ico图标','guige'=>'16*16','url'=>'http://www.ico.la','des'=>'请点击这里生成','name'=>'favicon.ico','address'=>''),            'png' => array('title'=>'浏览器头部png图标','guige'=>'32*32','des'=>'谷歌浏览器使用','name'=>'favicon.png','address'=>''),            'zq10' => array('title'=>'十元专区BANNER(theme_01)','guige'=>'任意*250','url'=>'yunbuy?zq=10','des'=>'','name'=>'ten_banner.jpg','address'=>'style/theme_01/css/images/'),            'zq100' => array('title'=>'百元专区BANNER(theme_01)','guige'=>'任意*250','url'=>'yunbuy?zq=100','des'=>'','name'=>'hundred-banner.jpg','address'=>'style/theme_01/css/images/'),            'zqlimit' => array('title'=>'限购专区BANNER(theme_01)','guige'=>'任意*250','url'=>'yunbuy?zq=limit','des'=>'','name'=>'purchase-banner.jpg','address'=>'style/theme_01/css/images/'),            'free' => array('title'=>'免费专区BANNER(theme_01)','guige'=>'任意*250','url'=>'yunbuy?type=2','des'=>'','name'=>'free-banner.jpg','address'=>'style/theme_01/css/images/'),            'appbg' => array('title'=>'首页APP二维码浮动背景','guige'=>'任意*150','url'=>'','des'=>'','name'=>'bottom.png','address'=>'style/theme_01/css/images/'),            'banner_qz' => array('title'=>'圈子列表页BANNER','guige'=>'任意*250','url'=>'quanzi','des'=>'圈子列表页','name'=>'banner_qz.jpg','address'=>'style/images/banner/'),    		'loaddown-banner' => array('title'=>'PC端APP下载页背景','guige'=>'1920*844','url'=>'content/html/apps','des'=>'PC端APP下载页面背景图','name'=>'loaddown-banner.jpg','address'=>'style/images/'),    		'loaddown-1' => array('title'=>'PC端APP下载页手机相片','guige'=>'252*442','url'=>'content/html/apps','des'=>'PC端APP下载页手机相片','name'=>'loaddown-1.png','address'=>'style/images/'),    		'loaddown-2' => array('title'=>'PC端APP下载页文字描述','guige'=>'309*172','url'=>'content/html/apps','des'=>'PC端APP下载页文字描述','name'=>'loaddown-2.png','address'=>'style/images/'),    		'mobile-loaddown-bg1' => array('title'=>'微信端APP下载页图片1','guige'=>'640*1072','url'=>'','des'=>'微信端端APP下载页主页图片','name'=>'mobile-loaddown-bg1.jpg','address'=>'style/images/'),    		'mobile-loaddown-bg2' => array('title'=>'微信端APP下载页图片2','guige'=>'548*881','url'=>'','des'=>'微信端端APP下载页打开浏览器','name'=>'mobile-loaddown-bg2.jpg','address'=>'style/images/'),    		'xz_logo' => array('title'=>'网盘logo','guige'=>'190*35','url'=>'','des'=>'网盘头部logo','name'=>'xz_logo.png','address'=>'images/'),    	);        #加载        $this->load->model('crowd');        if(!$this->crowd->crowd_power) unset($this->btnMenu['crowd']);                $this->smarty->assign('btnMenu',$this->btnMenu);        #加载        $this->load->model('setting');    }    //站点配置    function index($group = 'index'){        #group不存在时 默认第一个按钮        if(!array_key_exists($group, $this->btnMenu)){            $group = key($this->btnMenu);        }        $images_data = $this->images_data;        //更新配置        if(isset($_POST['Submit'])){        	            $post = $_POST['post'];            $post['group'] = $group;            //图片配置            if($group=='images'){            	$file = array();            	$file = $_FILES;            	$upload_file = array();            	foreach($file as $k=>$v){            		             		$file_path = $images_data[$k];            		if($v['name']==$file_path['name']){            			$upload_file[$k] = $v;            			$upload_file[$k]['address'] = $file_path['address'];            		}            		             	}            	foreach($upload_file as $k=>$v){            		$filename=$v["tmp_name"];            		$destination = $v['address'].$v["name"];            		             		if(!move_uploaded_file ($filename, $destination))            		{            			echo "移动文件出错";            			exit;            		}            	}            }            //文字碎片        	if($group=='words'){            	unset($post['group']);            	$configfile = AppDir.'includes/languages/common.php';            	$str = "<?php\n/** 前端公共语言包 */\n";            	foreach($post as $k=>$v) {            		/* if(in_array($k,array_keys($this->L))) {            		 $v = str_replace(array("'","\\"),"",trim($v));            		$configs[$k] = $v;            		$pattern[$k] = "/\['".$k."'\]\s*=\s*([']?)[^']*([']?)(\s*);/is";            		$replacement[$k] = "['".$k."'] = \${1}".$v."\${2}\${3};";            		} */            		$str .= "$"."L['".$k."'] = '".$v."';\n";            	}            	$str .= "$"."this->smarty->assign('L', $"."this->L=$"."L);";            	$str .= "\n?>";            	//$str = file_get_contents($configfile);            	//$str = preg_replace($pattern, $replacement, $str);            	file_put_contents($configfile, $str);                $this->tip('更新成功',array('inIframe'=>true));                $this->exeJs("main.refresh()");                die;            }            //配置后台域名            if(!empty($post['m_domain'])){                $post['m_domain'] = str_ireplace(array('http://','/'),'',$post['m_domain']);                $post['m_domain'] = trim($post['m_domain']);            }            //模板风格            if($group=='skin'){                $this->base->write_static_cache('skin',$post,'');                if(isset($_SESSION['pc_skin'])){                    unset($_SESSION['pc_skin']);                }            }            $res = $this->setting->update($post);            //微信配置            if($post['wx_login'] && !empty($post['wx_appid']) && $post['wx_appsecret']){                $oauth = array();                $oauth['appid'] = $post['wx_appid'];                $oauth['appsecret'] = $post['wx_appsecret'];                $this->db->save("###_oauth_wx",$oauth,'',"id = 1");            }            //删除二维码图片            if(!empty($post['ios_url']) || !empty($post['and_url'])){                @unlink(RootDir.'web/upload/images/qrcode/qrcode.png');            }            $this->base->clear_caches();            if(isset($res['code']) && $res['code']==0){                $this->tip($res['message'],array('inIframe'=>true));                $this->exeJs("main.refresh()");            }else{                $this->tip($res['message'],array('inIframe'=>true,'type'=>1));            }            die;        }        //提交自定义变量        elseif(isset($_POST['SubmitAdd'])){            $post = $_POST['post'];            $post['value'] = $_POST['setup']['default'];            $post['step'] = json_encode($_POST['setup']);            $post['form_type'] = $post['type'];            $res = $this->setting->add($post);            if(isset($res['code']) && $res['code']==0){                $this->tip($res['message'],array('inIframe'=>true));                $this->exeJs("parent.location.href='/manage#!setting/index/".$post['group']."'");            }else{                $this->tip($res['message'],array('inIframe'=>true,'type'=>1));            }            die;        }        if($group=='add'){            $field_type = array(                'text'=>'单行文本',                'textarea'=>'多行文本',                'select'=>'下拉列表',                'radio'=>'单选按钮',                'checkbox'=>'复选框',                'images'=>'图片上传控件',                'files'=>'文件上传控件',                'datetime'=>'日期和时间',            );            $this->smarty->assign('field_type',$this->form->select($field_type,'','name="post[type]" onchange="javascript:field.chang_field(this.value,\'\',true);"'));        }        elseif($group=='skin'){            $pc_list = array('cn');            $mobile_list = array('cn');            //获取模板目录            $path = AppDir.'views/skin/';            $this->load->library('dir');            $dir_list = $this->dir->dir_list($path, '', '', GLOB_ONLYDIR);            //得到模板            if($dir_list){                foreach($dir_list as $k=>$v){                    $v = str_replace($path, '', $v);                    if(substr_count($v,'/') > 1) continue;                    if(strpos($v,'/') === false){                        $pc_list[] = $v;                    }else{                        if(strpos($v,'/mobile')===false) continue;                        $v = str_replace('/mobile', '', $v);                        $mobile_list[] = $v;                    }                }            }            //获取当前模板            $data_skin = $this->setting->get_skin();            $this->smarty->assign('skin', $data_skin);            $this->smarty->assign('pc_list', $pc_list);            $this->smarty->assign('mobile_list', $mobile_list);        }        else{            $formInfo = $this->setting->formInfo($group);            $this->load->model('form_field');            foreach($formInfo as $k=>$v){                if(method_exists($this->form_field,$v['type'])){                    $v['html'] = $this->form_field->$v['type']($v,$v['value']);                }                $formInfo[$k] = $v;            }            $this->smarty->assign('formInfo',$formInfo);        }        $this->smarty->assign('images_data',$images_data);                $this->smarty->assign('btnNo',$group);        $this->smarty->display('manage/setting/config.html');    }    //其它配置提交    function config_other(){        if(isset($_POST['Submit'])){            $post = $_POST['config'];            $res = $this->setting->update_other($post);            $this->base->clear_caches();            if(isset($res['code']) && $res['code']==0){                $this->tip($res['message'],array('inIframe'=>true));                $this->exeJs("main.refresh()");            }else{                $this->tip($res['message'],array('inIframe'=>true,'type'=>1));            }        }        die;    }    //删除    function del(){        $id = $_POST['id'];        if(!$id) die;        admin_log('删除站点配置：'.$this->db->getstr("SELECT title FROM ###_config WHERE varname='".$id."'"));        $this->db->delete('###_config', array('varname'=>$id));        $this->base->clear_caches('static');        $this->tip('删除成功');    }    //测试邮箱    function testMail(){        $subject = 'lnest test mail';        $message = 'this is a test mail from lnest team';        $this->load->library('mail');		        if(empty($_POST['mailto'])) die('请填写测试邮箱地址');        $result = $this->mail->sendMail($_POST['mailto'],$subject,$message);        if($result == true && !is_array($result)){            exit('1');        }else{            if(!empty($result['error'])) {                exit($result['error']);            }else{                exit('邮件发送失败');            }        }    }    //清除缓存    function clearCaches(){        if(isset($_POST['Submit'])){            $post = $_POST['post'];            if(!empty($post)){                $count = $this->base->clear_caches($post);                $this->tip('成功清除缓存文件'.$count.'个',array('inIframe'=>true));            }else{                $this->tip('请选择缓存清理项！',array('inIframe'=>true,'type'=>1));            }            $this->exeJs("parent.com.xhide();parent.main.refresh()");die;        }        $this->smarty->display('manage/setting/clearCaches.html');    }}