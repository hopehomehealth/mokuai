<?php/** * Class menus_model */class menus_model extends Lowxp_Model{    private $baseTable = '###_menus';    function __construct(){}    /** 后台菜单 权限节点控制     * @param bool $node false只返回权限节点菜单 true链接权限控制     * @return array     */    function menus_node($node=true){        $class = Lowxp_Router::$class;        $x = Lowxp_Router::getInstance()->segments;        unset($x[0]);        $url = implode('/',$x);        $where = '';        if(GID != -1){            $group = $this->db->get("SELECT * FROM ###_m_user_group WHERE id=".GID);            if(!isset($group['id']) || empty($group['menu_list'])) die('该用户无权限!');            $where .= " AND id IN(".$group['menu_list'].")";        }        #权限节点        $menus_gid = array();        $res_gid = $this->db->select("SELECT * FROM ".$this->baseTable." WHERE status=1".$where." ORDER BY `listorder`,id");        foreach($res_gid as $v){            $menus_gid[] = $v['id'];        }        #所有节点        $menus_all = array();        $res = $this->db->select("SELECT id FROM ".$this->baseTable." WHERE status=1 ORDER BY `listorder`,id");        foreach($res as $v){            $menus_all[] = $v['id'];        }        //无权限的节点        $menus_diff = array_diff($menus_all,$menus_gid);        $menus_diff_url = array();        #权限判断        if(!empty($menus_diff) && $node){            $res = $this->db->select("SELECT `mod`,`action`,`param` FROM ".$this->baseTable." WHERE status=1 AND id IN(".implode(',',$menus_diff).")");            foreach($res as $v){                $menus_diff_url[] = trim($v['mod']).(trim($v['action'])?('/'.trim($v['action'])):'').(trim($v['param'])?('/'.trim($v['param'])):'');            }            foreach($menus_diff_url as $s){                if ($s==$url){                    return array('code'=>1001,'msg'=>'无权限访问');                }            }            return true;        }        return $res_gid;    }    //判断访客权限    function vor(){        $data = array('error'=>'无操作权限','vor'=>0);        if(isset($_SESSION['vor']) && $_SESSION['vor']==1){            $data['vor'] = 1;        }else{ return false; }        $segments = Lowxp_Router::getInstance()->segments;        $vor = false;        //屏蔽访客操作        $nodes01 = array('del','postMenu');        $nodes02 = array('Submit','action','status','install','uninstall');        foreach($nodes02 as $v){            if(isset($_POST[$v])){                if($v == 'action' && $_POST[$v] == 'agree') continue;                $vor=true;                $data['iniframe']=true;                break;            }        }        if($vor==false){            if(in_array($segments[2],$nodes01)){ $vor=true; }            else{ $vor = false; }        }        if($vor){ return $data; }        else{ return false; }    }    //保存数据    function save($post){        #表单处理        if(empty($post['name'])) return array('code'=>10001, 'message'=>'请输入菜单名称!');        if(empty($post['mod'])) return array('code'=>10001, 'message'=>'请输入模块名!');        #保存        $where = '';        $id = (int) $post['id'];        if($id){            #系统行不允许删除和移动            $row = $this->db->get("SELECT * FROM ###_menus WHERE id=".$id);            if($row['issystem'] && $post['parentid']>0 && $row['parentid']==0){                return array('code'=>10003, 'message'=>'该菜单模型关联，不可移动!');            }            $where = array('id'=>$id);            if(empty($post['icon'])){ unset($post['icon']); } #图标为空时不更新        }        $res = $this->db->save($this->baseTable,$post,'',$where);        if(empty($res)){ return array('code'=>10002, 'message'=>'数据操作失败!'); } //未知错误        if($post['id']){            admin_log('编辑后台菜单：'.$post['name']);            return array('code'=>0, 'type'=>'update', 'message'=>'更新成功');        }        else{            admin_log('编辑后台菜单：'.$post['name']);            return array('code'=>0, 'type'=>'insert', 'message'=>'添加成功');        }    }}