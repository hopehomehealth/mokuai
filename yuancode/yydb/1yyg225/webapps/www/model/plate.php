<?php/** * Class plate_model */class plate_model extends Lowxp_Model{    private $baseTable = '###_config_other';    function __construct(){ }    /** 设置奖项     * @var array     * key大转盘中奖回调标识 title奖项名称 number是配置赠送 points是否配置中奖概率     */    public $winConfig = array(        1 => array('key'=>1, 'title'=>'一等奖', 'number'=>'1', 'points'=>'1'),        2 => array('key'=>2, 'title'=>'二等奖', 'number'=>'1', 'points'=>'1'),        3 => array('key'=>3, 'title'=>'三等奖', 'number'=>'1', 'points'=>'1'),        4 => array('key'=>4, 'title'=>'四等奖', 'number'=>'1', 'points'=>'1'),        5 => array('key'=>5, 'title'=>'五等奖', 'number'=>'1', 'points'=>'1'),        0 => array('key'=>0, 'title'=>'未中奖', 'number'=>'0', 'points'=>'1'),    );    //配置赠送的币种    function getPoints($type=''){        $types = array(            1 => array('id'=>1, 'title'=>$this->L['unit_db_points']),            2 => array('id'=>2, 'title'=>$this->L['unit_bonus']),            3 => array('id'=>3, 'title'=>$this->L['unit_pay_points']),        );        if($type!==''){ return $types[$type]; }        else{ return $types; }    }    //格式化大转盘配置    function configFormat(){        $config_other = $this->setting->value_other();        $config_plate = array();        if($config_other){            foreach($config_other as $k=>$v){                if(strpos($k,'plate_')===false) continue;                if(strpos($k,'plate_points_')!==false){                    $config_plate['plate_points'][substr($k,-1,1)] = $v;                }                elseif(strpos($k,'plate_get_points_')!==false){                    $config_plate['plate_get_points'][substr($k,-1,1)] = $v;                }                elseif(strpos($k,'plate_get_type_')!==false){                    $config_plate['plate_get_type'][substr($k,-1,1)] = $v;                    $plate_get_title_type = $this->getPoints($v);                    $config_plate['plate_get_title_type'][substr($k,-1,1)] = $plate_get_title_type['title'];                }                else{                    $config_plate[$k] = $v;                }            }        }        if(is_array($config_plate['plate_points'])){            ksort($config_plate['plate_points']);        }        if(is_array($config_plate['plate_get_points'])){            ksort($config_plate['plate_get_points']);        }        if(is_array($config_plate['plate_get_type'])){            ksort($config_plate['plate_get_type']);        }        if(is_array($config_plate['plate_get_title_type'])){            ksort($config_plate['plate_get_title_type']);        }        return $config_plate;    }    //会员抽奖条件    function plate_cond($mid){        $data = array();        if(!$mid){ return $data; }        $this->load->model('member');        $member = $this->member->member_info($mid);        //大转盘配置        $config_plate = $this->configFormat();        //总参与人次        $sql = "SELECT SUM(qty*price) AS qty FROM ###_yundb WHERE type=1 AND status>1 AND mid='$mid'";        $data['countDb'] = $this->db->getstr($sql);        $data['countDb'] || $data['countDb'] = 0;        //参与抽奖已使用的人次        $sql = "SELECT SUM(cond_number) AS qty FROM ###_plate_log WHERE `cond`=1 AND mid='$mid'";        $data['countDb_finished'] = $this->db->getstr($sql);        $data['countDb_finished'] || $data['countDb_finished'] = 0;        //剩余可抽奖的参与人次        $data['countDb_un'] = $data['countDb'] - $data['countDb_finished'];        $data['countDb_un'] >= 0 || $data['countDb_un'] = 0;        //剩余参与人次可抽奖次数        $data['countDb_qty'] = $config_plate['plate_db_points'] ? floor($data['countDb_un']/$config_plate['plate_db_points']) : 0;        //剩余积分        $data['countPay'] = $member['pay_points'];        //剩余积分可抽奖次数        $data['countPay_qty'] = $config_plate['plate_pay_points'] ? floor($data['countPay']/$config_plate['plate_pay_points']) : 0;        //可抽奖总次数        $data['count_qty'] = $data['countDb_qty'] + $data['countPay_qty'];        $data['username'] = $member['username'];        $data['nickname'] = $member['nickname'];        $data['photo'] = $member['photo'];       return $data;    }    //大转盘状态    function plate_status(){        //大转盘配置        $config_plate = $this->configFormat();        $data['status'] = 1;        if(!intval($config_plate['plate_db_points']) && !intval($config_plate['plate_pay_points'])){            $data['status'] = -1; #未配置 大转盘参与条件            $data['status_name'] = '亲，活动尚未开启！';            $data['status_tip'] = '暂未开放大转盘活动，敬请期待。';            $data['status_btn'] = '去'.$this->L['unit_yun'];            $data['status_url'] = '/yunbuy';        }        elseif(strtotime($config_plate['plate_start_time']) > time()){            $data['status'] = -2; #大转盘活动还未开始            $data['status_name'] = '亲，活动还没开始哦！';            $data['status_tip'] = '大转盘活动于'.date('Y年m月d日 H时i分').'开启，敬请期待！';            $data['status_btn'] = '去'.$this->L['unit_yun'];            $data['status_url'] = '/yunbuy';        }        elseif(strtotime($config_plate['plate_end_time']) < time()){            $data['status'] = -3; #大转盘活动已经结束            $data['status_name'] = '亲，活动已结束！';            $data['status_tip'] = '大转盘活动已结束，下期开启，请持续关注。';            $data['status_btn'] = '去'.$this->L['unit_yun'];            $data['status_url'] = '/yunbuy';        }        elseif(!$_SESSION['mid']){            $data['status'] = -4; #未登陆            $data['status_name'] = '请先登陆！';            $data['status_tip'] = '亲，您还未登陆，请先登陆。';            $data['status_btn'] = '立即登录';            $data['status_url'] = '/member/login?back=/plate';        }        if($data['status'] == 1){            $data = array_merge($data, $this->plate_cond($_SESSION['mid']));            if(!$data['count_qty']){                $data['status'] = -5; #已没有抽奖次数                $data['status_name'] = '您的抽奖次数已用完！';                $data['status_tip'] = '抽奖次数已用完了，去'.$this->L['unit_yun'].'获取更多大转盘机会！';                $data['status_btn'] = '去'.$this->L['unit_yun'];                $data['status_url'] = '/yunbuy';            }            elseif($data['countDb_qty']>0){                $data['status'] = 2; #使用消费次数                $data['status_name'] = '消费'.$config_plate['plate_db_points'].'人次可抽奖一次';            }else{                $data['status'] = 3; #使用积分                $data['status_name'] = '单次抽奖消耗'.$config_plate['plate_pay_points'].$this->L['unit_pay_points'];            }        }        return $data;    }}