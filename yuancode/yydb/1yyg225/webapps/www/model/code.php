<?php/** * Class 验证码模型 */class code_model extends Lowxp_Model{    private $type = 'ss'; //验证码类型 tou点触科技 gee极验验证 ss算术验证    private $open = 1; //是否开启验证码    //验证码加载    function __construct(){        define('TYPE_CODE', $this->type);        if(TYPE_CODE == 'tou'){ #点触科技            define("PUBLIC_KEY_CODE", "");            define("PRIVATE_KEY_CODE", "");        }        elseif(TYPE_CODE == 'gee'){ #极验验证            define("PUBLIC_KEY_CODE", "");            define("PRIVATE_KEY_CODE","");            include(AppDir.'function/geetestlib.php');            $gee=http('http://api.geetest.com/check_status.php','get',array('http'=>array('method'=>"GET",'timeout'=>3)));            define('GEE_CODE', $gee);        }        else{ #算术验证        }    }    //生成验证码    function html($options = array()){        $this->open = isset($options['open']) ? $options['open'] : 1; #是否开启验证码        if(TYPE_CODE == 'gee'){            $gee = $options['gee'] ? $options['gee'] : 1;            $this->smarty->assign('gee', $gee);            $this->smarty->assign('geeJs', "https://api.geetest.com/get.php?gt=".PUBLIC_KEY_CODE."&random=".rand(1,100000).($gee==2 ? "&product=popup&popupbtnid=submit-button" : ""));        }        $html = $this->smarty->fetch('code/'.($options['template']?$options['template']:'regist').'.html');        $this->smarty->assign('html_code', $this->open ? $html : '');    }    //检查验证码    function check(){        $result = array('code'=>0,'msg'=>'');        if($this->open != 1) return $result;        if(TYPE_CODE == 'tou'){ #点触科技            $check_key = $_POST['check_key'];            $check_address = $_POST['check_address'];            $this->load->library('touclick');            $res = $this->touclick->touclickCheck(PUBLIC_KEY_CODE, PRIVATE_KEY_CODE, $check_key, $check_address);            if(!$res){ $result = array('code'=>1,'msg'=>'验证码未通过！'); }        }        elseif(TYPE_CODE == 'gee' && GEE_CODE == 'ok'){ #极验验证            $validate_response = geetest_validate(@$_POST['geetest_challenge'], @$_POST['geetest_validate'], @$_POST['geetest_seccode']);            if(!$validate_response){ $result = array('code'=>1,'msg'=>'请拖动验证码完成验证！'); }        }        else{ #算术验证            $scode = empty($_POST['scode']) ? '' : trim($_POST['scode']);            if(!$scode){                $result = array('code'=>1,'msg'=>'验证码不能为空！');            }            elseif (strtolower($scode) != strtolower($_SESSION['icode'])) {                $result = array('code'=>1,'msg'=>'验证码输入错误！');            }        }        return $result;    }}