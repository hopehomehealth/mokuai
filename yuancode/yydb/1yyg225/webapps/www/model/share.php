<?phpclass share_model extends Lowxp_Model{    /**     * 加入一个表的相关字段数据     * --------------------     * @param array $data    需要增加字段的数据     * @param string $table  往哪个表加数据     * @param string $select 查询的字段,将join到$data中     * @param string $filter 源数据过滤出的id     * @param string $where  新表的条件字段IN($ids)     * @param array  $conds  附加字段     * @param string $pre    新数据前缀     * @return mixed         返回原数据     */    function lJoin($data,$table,$select='id,uid',$filter='',$where='',$pre='',$conds=array()){        if(empty($data))return $data;        $ids = array();$in = $filter;        foreach($data as $v)if(!empty($v[$in]))$ids[$v[$in]]=$v[$in];#获取where in 的 ids        $condition = $where." IN(".implode(',',$ids).")";        if(count($conds)>0)foreach($conds as $k=>$v)$condition.= " AND ".addslashes($k)."='".addslashes($v)."'";        $res = $this->db->select("SELECT ".$select." FROM `".$table."` WHERE ".$condition);        $attach = array();foreach($res as $v)$attach[$v[$where]] = $v;#数据对接        $join_field = explode(',',$select);        foreach($data as $k=>$v){            foreach($join_field as $val){                $val=trim(trim($val),'`');                $data[$k][$pre.$val] = isset($attach[$v[$in]][$val])?$attach[$v[$in]][$val]:'';            }        }        return $data;    }    function data_column($data,$field){        $ret = array();        foreach($data as $v)$ret[] = $v[$field];        return $ret;    }    /**     * 发起HTTP请求     * @param $url     * @param string $method     * @param array $params     * @return mixed     */    function http($url, $method = 'get', $params = array()){        $ch = curl_init();        curl_setopt($ch, CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_1_1);        curl_setopt($ch, CURLOPT_HEADER, 0); #返回头部信息        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);        curl_setopt($ch, CURLOPT_TIMEOUT, 30);        $HttpHeader = array(            'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',            'Connection: keep-alive',            'Cache-Control: no-cache',            'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',            'Pragma: no-cache',            'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.63 Safari/537.36',            'Accept-Encoding: gzip,deflate,sdch',            'Accept-Language: zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4',            #'X-Requested-With: XMLHttpRequest',        );        //取消SSL验证        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER,false);        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST,false);        if (strtolower($method) == 'post'){            $fields = http_build_query($params);            curl_setopt($ch, CURLOPT_POST, 1);            curl_setopt($ch, CURLOPT_POSTFIELDS, $fields);        }else{            //Get请求,处理地址中包含的参数.            $segments = parse_url($url);            if(isset($segments['query']) && $segments['query']!=''){                parse_str($segments['query'],$params2);                $params = array_merge($params, $params2);            }            $fields = http_build_query($params);            $url = $segments['scheme'].'://'.$segments['host'].$segments['path'];            if($fields!='')$url = $url.'?'.$fields;            curl_setopt($ch, CURLOPT_HTTPGET, 1);        }        curl_setopt($ch, CURLOPT_HTTPHEADER, $HttpHeader);        curl_setopt($ch, CURLOPT_URL, $url);        #curl_setopt($ch, CURLOPT_HEADER, 1);        curl_setopt($ch, CURLOPT_ENCODING, "gzip");        #echo $url;die;        $ret = curl_exec($ch);        curl_close($ch);        return $ret;    }    /**     * 设置Excel基本信息     * @param $filename     * @param $title     */    function SetExcelHeader($filename, $title){        header("Content-type:application/octet-stream");        header("Accept-Ranges:bytes");        header("Content-Type: application/vnd.ms-excel; charset=GBK");        header("Content-Disposition:attachment;filename=$filename.xls");        header("Pragma: no-cache");        header("Expires: 0");    }    /**     * 导出Excel文本     * @param $fields     * @param $data     */    function SetExcelBody($fields, $data){        //echo "<style>br {mso-data-placement:same-cell;} </style>";        foreach($fields as $v)echo iconv("utf-8", "GBK", $v)."\t";        echo "\n";        $keys = array_keys($fields);        foreach ($data as $value){            foreach($keys as $key){                if(!empty($value[$key])){                    $value[$key] = preg_replace('/[\s]{2,}/','',$value[$key]);                    $value[$key] = str_replace(array("\"","\'",'=',"\t","\n"),                        array('“','’','＝','\t','\n'),                        $value[$key]);                    echo iconv("utf-8", "GBK", $value[$key])."\t";                }else{                    echo "\t";                }            }            echo "\n";        }        die;    }    /**     * 根据经纬度计算距离,单位米     * @param $lng1     * @param $lat1     * @param $lng2     * @param $lat2     * @return int     */    function getdistance($lng1,$lat1,$lng2,$lat2){        //将角度转为狐度        $radLat1=deg2rad($lat1);        $radLat2=deg2rad($lat2);        $radLng1=deg2rad($lng1);        $radLng2=deg2rad($lng2);        $a=$radLat1-$radLat2;//两纬度之差,纬度<90        $b=$radLng1-$radLng2;//两经度之差纬度<180        $s=2*asin(sqrt(pow(sin($a/2),2)+cos($radLat1)*cos($radLat2)*pow(sin($b/2),2)))*6378.137*1000;        return $s;    }    function BaiduToGps($lng,$lat){        // 经度,纬度        $x = $lng;        $y = $lat;        $Baidu_Server = "http://api.map.baidu.com/ag/coord/convert?from=0&to=4&x={$x}&y={$y}";        $result = @file_get_contents($Baidu_Server);        $json = json_decode($result);        if($json->error == 0)        {            $bx = base64_decode($json->x);            $by = base64_decode($json->y);            $GPS_x = 2 * $x - $bx;            $GPS_y = 2 * $y - $by;            return $GPS_x.','.$GPS_y;//经度,纬度        }        return false;    }    /*echo '百度坐标: ',$lnglat,'<br><br>','转换后GPS坐标: ',FromBaiduToGpsXY($lnglat),'<br><br>';echo '转换前距离: ',P2PDistance('31.224286666667,121.420675','31.224665,121.437518'),'<br/>';echo '转换后距离: ',P2PDistance('31.224286666667,121.420675','31.220157068379,121.42647022694');  */    /**     * 把图片装进固定宽高的容器中,得到自适应宽高尺寸.     * @param $sizestr     * @param $newWidth     * @param $newHeight     * @return array     */    function getSizeFormat($sizestr, $newWidth,$newHeight){        $size = explode('x',$sizestr);        if(count($size)!=2)return array('width'=>'auto','height'=>'auto');        $w = $size[0];        $h = $size[1];        $newWidth / $w < $newHeight / $h            ? ($newHeight = round($newWidth*$h/$w,1))            : ($newWidth = round($newHeight*$w/$h,1));        return array('width'=>$newWidth,'height'=>$newHeight);    }}