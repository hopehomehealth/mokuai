<?php/** * Class admin_model */class admin_model extends Lowxp_Model{    public $baseTable = '###_m_user';    public $groupTable = '###_m_user_group';    public $logTable = '###_m_user_log';    #保存管理员信息    function save(){        $post = $_POST['post'];        $id = $_POST['id'];        #表单处理        if(empty($post['username'])){ return array('code'=>10001, 'message'=>'用户名不能为空!'); }        if(!$id){            if($post['pass1']!=$post['pass2']){ return array('code'=>10001, 'message'=>'两次密码不一致!'); }            if(strlen($post['pass1'])<6){ return array('code'=>10001, 'message'=>'新密码太短,长度在6-16位！!'); }            if(strlen($post['pass1'])>16){ return array('code'=>10001, 'message'=>'新密码太长,长度在6-16位！!'); }        }else{            if($post['pass1'] && $post['pass1']!=$post['pass2']){ return array('code'=>10001, 'message'=>'两次密码不一致!'); }            if($post['pass1'] && strlen($post['pass1'])<6){ return array('code'=>10001, 'message'=>'新密码太短,长度在6-16位！!'); }            if($post['pass1'] && strlen($post['pass1'])>16){ return array('code'=>10001, 'message'=>'新密码太长,长度在6-16位！!'); }        }        #重复值        $where = $id ? ' and id!='.$id : '';        $res = $this->db->select("select uid from ".$this->baseTable." where username='".$post['username']."'".$where);        if($res){ return array('code'=>10003, 'message'=>'用户名已存在，请更换!'); }        #修改        if($id){            $user = $this->db->query("SELECT * FROM `".$this->baseTable."` WHERE `uid` = '".intval($id)."'")->row_array();            if($user['password'] != $this->get_salt_hash($post['oldpass'], $user['salt']) && 1==2){                return array('code'=>10003, 'message'=>'旧密码输入错误!');            }else{                $setPass = $post['pass1'] ? $this->get_salt_hash($post['pass1'],$user['salt']) : $user['password'];                $res = $this->db->update('###_m_user',array(                    'username'=>$post['username'],                    'password'=>$setPass,                    'u_time'=>RUN_TIME,                    'group_id'=>$post['group_id'],                    'tel'    =>isset($post['tel']) ? $post['tel'] : '',                    'desc'    =>$post['desc'],                    'visitor'  =>$post['visitor']                ),array('uid'=>intval($id)));                if($res){                    admin_log('编辑管理员：'.$post['username']);                    return array('code'=>0, 'type'=>'update', 'message'=>'更新成功');                }                else{ return array('code'=>10002, 'message'=>'数据操作失败!'); }            }        }        #添加        else{            $salt = substr(uniqid(rand()), -6);            $hash_pass = $this->get_salt_hash($post['pass1'], $salt);            $res = $this->db->insert('###_m_user',array(                'username'=>$post['username'],                'password'=>$hash_pass,                'salt'=>$salt,                'c_time'=>RUN_TIME,                'u_time'=>RUN_TIME,                'lastlogin'=>RUN_TIME,                'ip'=>getIP(),                'group_id'=>$post['group_id'],                'tel'    =>isset($post['tel']) ? $post['tel'] : '',                'desc'    =>$post['desc'],                'visitor'  =>$post['visitor']            ));            if($res){                admin_log('添加管理员：'.$post['username']);                return array('code'=>0, 'type'=>'update', 'message'=>'添加成功');            }            else{ return array('code'=>10002, 'message'=>'数据操作失败!'); }        }    }    #更新会员组    function save_role(){        $post = $_POST['post'];        $id = $post['id'];        #表单处理        if(empty($post['name'])){ return array('code'=>10001, 'message'=>'请输入角色名称!'); }        #初始值        $post['menu_list'] = implode(',',$post['menu_list']);        #重复处理        $where = $id ? ' and id!='.$id : '';        $res = $this->db->select("select * from ".$this->groupTable." where name='".$post['name']."'".$where);        if($res){ return array('code'=>10003, 'message'=>'角色名称已存在，请更换!'); }        #保存        $where = $id ? array('id'=>$id) : '';        $res = $this->db->save($this->groupTable,$post,'',$where);        if(empty($res)){ return array('code'=>10002, 'message'=>'数据操作失败!'); } //未知错误        if($id){            admin_log('编辑管理员角色：'.$post['name']);            return array('code'=>0, 'type'=>'update', 'message'=>'更新成功');        }else{            admin_log('添加管理员角色：'.$post['name']);            return array('code'=>0, 'type'=>'insert', 'message'=>'添加成功');        }    }    /**     * 获取加密的密码     *     * @param $password     * @param $salt     * @param string $gsalt     * @return string     */    public function get_salt_hash($password, $salt, $gsalt='scYltK') {        $passwordmd5 = preg_match('/^\w{32}$/', $password) ? $password : md5($password);        return md5($passwordmd5.$salt.$gsalt);    }}