<?php/** * Class payment_model */class payment_model extends Lowxp_Model{    public $baseTable = '###_payment';    function __construct(){}    //保存数据    function save(){        $post = $_POST['post'];        $id = intval($_POST['id']);        #表单处理        if(empty($post['pay_name'])){ return array('code'=>10001, 'message'=>'请输入支付方式名称!'); }        $sql = "SELECT COUNT(*) FROM " . $this->baseTable . " WHERE pay_name='". $post['pay_name'] ."' AND pay_code<>'". $post['pay_code'] ."'";        if($this->db->getstr($sql)){ return array('code'=>10001, 'message'=>'支付方式名称已经存在!'); }        #初始值 格式化        $msg = '';        $post['pay_fee'] = empty($post['pay_fee'])?0:trim($post['pay_fee']);        #取得支付配置信息        $post['pay_config'] = array();        if (isset($_POST['cfg_value']) && is_array($_POST['cfg_value']))        {            for ($i = 0; $i < count($_POST['cfg_value']); $i++)            {                $post['pay_config'][] = array(                    'name'  => trim($_POST['cfg_name'][$i]),                    'type'  => trim($_POST['cfg_type'][$i]),                    'value' => trim($_POST['cfg_value'][$i])                );            }        }        $post['pay_config'] = serialize($post['pay_config']);        if($id){ #编辑            $msg = '更新成功';        }else{ #安装            $msg = '安装成功';            #数据库已经存在，获取id            $sql = "SELECT pay_id FROM " . $this->baseTable . " WHERE pay_code='". $post['pay_code'] ."'";            $id = $this->db->getstr($sql);            $post['enabled'] = 1;        }        #处理图片数据        if(isset($post['thumb']) && !empty($post['thumb'])){            $arrData = array();            foreach($post['thumb']['path'] as $k=>$v){                $arrData[$k]['path'] = $v;                $arrData[$k]['title'] = $post['thumb']['title'][$k];            }            $post['thumb'] = json_encode($arrData);        }        #保存        $where = $id ? array('pay_id'=>$id) : '';        $res = $this->db->save($this->baseTable,$post,'',$where);        if(empty($res)){ return array('code'=>10002, 'message'=>'数据操作失败!'); }        if($id){            admin_log('编辑支付方式：'.$post['pay_name']);            return array('code'=>0, 'type'=>'update', 'message'=>$msg);        }        else{            admin_log('安装支付方式：'.$post['pay_name']);            return array('code'=>0, 'type'=>'insert', 'message'=>$msg);        }    }    //支付列表    function getPayment($where){        $payment = $this->db->select("SELECT * FROM ".$this->baseTable." WHERE pay_id <> 0 AND $where ORDER BY pay_order");        if($this->mod != 'manage'){            //获取匹配的终端            $clients = $this->clients_array();            foreach($payment as $k=>$v){                $clients_keys = isset($clients[$v['pay_code']]['keys']) ? $clients[$v['pay_code']]['keys'] : '';                if(!$clients_keys) continue;                if(defined('IS_APP') && IS_APP){                    if(strpos($clients_keys, 'app') === false){ unset($payment[$k]); }                    continue;                }                if(defined('IS_MOBILE') && IS_MOBILE){                    if(defined('IS_WECHAT') && IS_WECHAT && strpos($clients_keys, 'wx') === false){ unset($payment[$k]); }                    elseif(defined('IS_WECHAT') && !IS_WECHAT && strpos($clients_keys, 'wap') === false){ unset($payment[$k]); }                    continue;                }                if(defined('IS_PC') && IS_PC && strpos($clients_keys, 'pc') === false){                    unset($payment[$k]); continue;                }                $payment[$k] = $v;            }        }        #重新排序 后台排序功能失效 故修改        //sort($payment);        $payment_list = array();        if(!empty($payment)){            foreach($payment as $val){                $payment_list[] = $val;            }        }        return $payment_list;    }    //支付信息    function payment_info($pay_id){        $info = $this->db->get("SELECT * FROM ".$this->baseTable." WHERE pay_id = '$pay_id'");        return $info;    }    //保存支付日志    function pay_log_save($input){        if($input['log_id']){            $log_id = $input['log_id'];            unset($input['log_id']);            $r = $this->db->update('###_pay_log',$input,array('log_id'=>$log_id));        }else{            $r = $this->db->insert('###_pay_log',$input);            return $this->db->insert_id();        }        return $r;    }    //支付日志信息    function pay_log($log_id){        $info = $this->db->get("SELECT * FROM ###_pay_log WHERE log_id = '$log_id'");        return $info;    }    //支付手续费    function pay_fee($pay_id,$order_amount,$cod_fee=0){        $pay_fee = 0;        $payment = $this->payment_info($pay_id);        $rate    = ($payment['is_cod'] && !is_null($cod_fee)) ? $cod_fee : $payment['pay_fee'];        if (strpos($rate, '%') !== false)        {            /* 支付费用是一个比例 */            $val     = floatval($rate) / 100;            $pay_fee = $val > 0 ? $order_amount * $val : 0;        }        else        {            $pay_fee = floatval($rate);        }        return round($pay_fee, 2);    }    //支付接口终端匹配    function clients_array(){        $array = array(            'aibei'      => 'pc wap wx app', //爱贝支付            'alipay'     => 'pc', //支付宝            'chinabank'  => 'pc wap wx', //网银在线            'heepay'     => 'pc wap', //汇付宝 网银支付            'heepaywechat' => 'pc wap wx app', //汇付宝 微信支付            'ipaynow'    => 'app', //现在支付            'jdpay'      => 'pc wap wx app', //京东支付            'jhpay'      => 'pc wap wx app', //聚合富            'jubaopay'   => 'pc wap wx app', //聚宝付            'kuaiqian'   => 'pc wap wx', //快钱            'teegon'     => 'pc wap wx', //天工支付            'tenpay'     => 'pc wap wx', //财付通            'wxpay'      => 'pc wx', //微信端支付            'wxpayapp'   => 'app', //微信APP支付            'yoyipay'    => 'pc wap wx', //甬易支付            'yunpay'     => 'pc wap wx', //云支付			'wapalipay'  => 'wap', //移动端支付宝			'swiftpass'  => 'pc wx app', //威富通支付            'jianpay'    => 'pc', //简单支付（支付宝）            'jianpaywx'  => 'wx', //简单支付（微信公众号）            'jianpaywxm' => 'pc', //简单支付（微信扫码）            'jianpaywapalipay'  => 'wap wx', //简单支付（微信扫码）            'shanpay'    => 'pc wap wx app', //云通付        );        foreach($array as $k=>$v){            $arr = array('keys'=>$v, 'values'=>'');            if(strpos($v,'pc') !== false){ $arr['values'] .= 'PC端 '; }            if(strpos($v,'wap') !== false){ $arr['values'] .= 'WAP端 '; }            if(strpos($v,'wx') !== false){ $arr['values'] .= '微信端 '; }            if(strpos($v,'app') !== false){ $arr['values'] .= 'APP '; }            $array[$k] = $arr;        }        return $array;    }}